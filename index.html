<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Five Borough Illegal Factions</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
<!-- Supabase Client (deferred) -->
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0a0a0a;
  --bg-secondary:#0d1117;
  --bg-tertiary:#161b22;
  --accent:#1e90ff;
  --accent-2:#4169e1;
  --accent-hover:#4682b4;
  --accent-2-hover:#5a9fd4;
  --muted:#8b949e;
  --text:#ffffff;
  --text-secondary:#c9d1d9;
  --glass-border: rgba(30,144,255,.15);
  --glass-border-blue: rgba(65,105,225,.15);
  --maxw:1400px;
  --kill-glow: 0 8px 32px rgba(30,144,255,0.4);
  --shadow: 0 4px 16px rgba(0,0,0,.4);
  --card-bg: linear-gradient(135deg, rgba(22,27,34,.95) 0%, rgba(13,17,23,.95) 100%);
}

/* base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Rajdhani",sans-serif;background:#0a0a0a;color:var(--text);-webkit-font-smoothing:antialiased;}

/* Performance optimizations */
* { -webkit-tap-highlight-color: transparent; }
.card, .victory-item, .drop-card { contain: layout style paint; transform: translateZ(0); }
.modal-overlay, .victory-overlay { will-change: opacity; backface-visibility: hidden; }
.victory-card { will-change: transform, opacity; transform: translateZ(0); backface-visibility: hidden; }
img { will-change: auto; transform: translateZ(0); }
.grid { contain: layout style; }
.victory-items-grid { contain: layout; }

/* ---------------------------
   Background + Forum Aesthetic
   --------------------------- */
#bgVideo {
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:0;
  filter: blur(3px) saturate(.8) brightness(.6);
  transform: translateZ(0);
}
#bgDark {
  position:fixed;
  inset:0;
  background: linear-gradient(180deg, rgba(10,10,10,0.85), rgba(0,0,0,0.92));
  z-index:1;
}
#bgEmblem {
  position:fixed;
  top:50%;
  left:50%;
  width:60vw;
  max-width:920px;
  transform:translate(-50%,-50%);
  opacity:0.04;
  z-index:1;
  pointer-events:none;
  filter: blur(2px);
}

/* container */
.wrap{ position:relative; z-index:6; width:100%; max-width:var(--maxw); margin:0 auto; padding:20px; }

/* main panel - Modern Forum Style */
.container{ 
  background: var(--card-bg); 
  border-radius:20px; 
  padding:32px; 
  border:2px solid var(--glass-border); 
  box-shadow:var(--shadow), 0 0 0 1px rgba(30,144,255,.1); 
  position:relative;
  overflow:hidden;
}
.container::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
}

/* header - Forum Style */
.header{ 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  gap:24px; 
  margin-bottom:32px; 
  padding-bottom:24px;
  border-bottom:2px solid transparent;
  border-image:linear-gradient(90deg, var(--accent) 0%, transparent 100%) 1;
}
.header-left{ max-width:70%; }
.title{ 
  font-size:48px; 
  margin:0; 
  line-height:1.1; 
  font-weight:900; 
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  text-shadow:none;
  letter-spacing:-1px;
}
.subtitle{ 
  margin-top:12px; 
  color:var(--text-secondary); 
  font-weight:700; 
  font-size:16px;
  letter-spacing:0.5px;
}

/* top navigation - Modern Tabs */
.topnav{ 
  display:flex; 
  gap:6px; 
  margin-top:20px; 
  flex-wrap:wrap; 
  align-items:center; 
  background:rgba(18,18,18,.6);
  padding:8px;
  border-radius:16px;
  border:1px solid var(--glass-border);
}
.topnav .cat{ 
  padding:14px 24px; 
  border-radius:12px; 
  background:transparent;
  color:var(--text-secondary); 
  border:none; 
  font-weight:800; 
  cursor:pointer; 
  display:inline-flex; 
  gap:10px; 
  align-items:center; 
  transition:all .3s;
  text-transform:uppercase;
  font-size:13px;
  letter-spacing:1px;
  position:relative;
}
.topnav .cat::after{
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:3px;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
  transform:scaleX(0);
  transition:transform .3s;
}
.topnav .cat:hover{
  color:var(--text);
  background:rgba(255,255,255,.05);
}
.topnav .cat.active{ 
  color:var(--text); 
  background: linear-gradient(135deg, rgba(30,144,255,.2), rgba(13,17,23,.2)); 
  box-shadow: inset 0 0 20px rgba(30,144,255,.2); 
}
.topnav .cat.active::after{
  transform:scaleX(1);
}

/* subtabs - Pill Style */
.subtabs{ 
  margin-top:16px; 
  display:flex; 
  gap:8px; 
  align-items:center; 
  flex-wrap:wrap; 
}
.subtabs .sub{ 
  padding:10px 20px; 
  border-radius:999px; 
  background: var(--bg-tertiary); 
  border:2px solid transparent; 
  color:var(--muted); 
  font-weight:800; 
  cursor:pointer; 
  transition:all .3s; 
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:1px;
}
.subtabs .sub:hover{
  border-color:var(--glass-border);
  color:var(--text-secondary);
  transform:translateY(-2px);
}
.subtabs .sub.active{ 
  color:#fff; 
  background: linear-gradient(135deg, var(--accent), var(--accent-2)); 
  box-shadow: 0 4px 16px rgba(30,144,255,.4); 
  border-color:transparent; 
  transform:translateY(-2px); 
}

/* header right/logo - Modern Forum Badge */
.header-right{ display:flex; align-items:center; gap:16px; }
.logo { 
  width:100px; 
  height:100px; 
  border-radius:20px; 
  overflow:hidden; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  border:3px solid var(--accent); 
  background: var(--card-bg); 
  box-shadow: 0 8px 30px rgba(30,144,255,.3), 0 0 0 1px rgba(30,144,255,.2); 
  transition:all .3s;
  position:relative;
}
.logo::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(30,144,255,.1) 0%, rgba(13,17,23,.1) 100%);
  opacity:0;
  transition:opacity .3s;
}
.logo:hover{
  transform:scale(1.05) rotate(2deg);
  border-color:var(--accent-hover);
  box-shadow: 0 12px 40px rgba(30,144,255,.5);
}
.logo:hover::before{
  opacity:1;
}
.header-logo{ 
  width:90%; 
  height:90%; 
  object-fit:contain; 
  display:block; 
  filter: drop-shadow(0 4px 12px rgba(30,144,255,.4)); 
  position:relative;
  z-index:1;
}

/* controls - Modern Forum Toolbar */
.controls{ 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  gap:16px; 
  margin-top:24px; 
  padding:16px;
  background:var(--bg-secondary);
  border-radius:12px;
  border:1px solid var(--glass-border);
}
.controls .left{ display:flex; gap:12px; align-items:center; }
.choose{ color:var(--text-secondary); font-weight:800; margin-right:8px; text-transform:uppercase; font-size:12px; letter-spacing:1px; }
select{ 
  background:var(--bg-tertiary); 
  border:2px solid var(--glass-border); 
  color:var(--text); 
  padding:10px 16px; 
  border-radius:10px; 
  font-weight:800; 
  transition:all .3s;
  font-size:14px;
}
select:hover{
  border-color:var(--accent);
}
select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(30,144,255,.2);
}

.drop-actions{ display:flex; gap:12px; align-items:center; }
.btn{ 
  padding:12px 24px; 
  border-radius:12px; 
  font-weight:900; 
  cursor:pointer; 
  background: var(--bg-tertiary); 
  border:2px solid var(--glass-border); 
  color:var(--text); 
  transition:all .3s;
  text-transform:uppercase;
  font-size:13px;
  letter-spacing:1px;
  position:relative;
  overflow:hidden;
}
.btn::before{
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  background:rgba(255,255,255,.1);
  border-radius:50%;
  transform:translate(-50%,-50%);
  transition:width .4s, height .4s;
}
.btn:hover::before{
  width:300px;
  height:300px;
}
.btn:hover{
  border-color:var(--accent);
  color:#fff;
  transform:translateY(-2px);
}
.btn.drop{ 
  background: linear-gradient(135deg, var(--accent), var(--accent-2)); 
  box-shadow: 0 4px 16px rgba(30,144,255,.4); 
  color:white; 
  border-color:transparent;
}
.btn.drop:hover{
  background: linear-gradient(135deg, var(--accent-hover), var(--accent-2-hover)); 
  box-shadow: 0 6px 24px rgba(30,144,255,.6); 
}

/* music toggle - Modern Switch */
.music-toggle{ 
  display:inline-flex; 
  align-items:center; 
  gap:10px; 
  padding:12px 20px; 
  border-radius:12px; 
  background:var(--bg-tertiary); 
  border:2px solid var(--glass-border); 
  color:var(--muted); 
  font-weight:800; 
  cursor:pointer; 
  transition:all .3s;
  text-transform:uppercase;
  font-size:12px;
  letter-spacing:1px;
}
.music-toggle:hover{
  border-color:var(--accent);
  transform:translateY(-2px);
}
.music-toggle.on{ 
  color:var(--accent); 
  background:rgba(30,144,255,.1);
  border-color:var(--accent);
  box-shadow: 0 4px 16px rgba(30,144,255,.3); 
}

/* grid - Modern Forum Cards Container */
.grid-wrap{ 
  margin-top:24px; 
  border-radius:16px; 
  padding:24px; 
  border:1px solid var(--glass-border); 
  background: rgba(18,18,18,.4); 
  box-shadow: inset 0 2px 10px rgba(0,0,0,.3); 
}
.grid{ 
  display:grid; 
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); 
  gap:20px; 
  align-items:stretch; 
  transform: translateZ(0); 
}

/* cards - Modern Forum Post Style */
.card{ 
  border-radius:16px; 
  padding:16px; 
  background: var(--card-bg); 
  border:2px solid transparent; 
  min-height:240px; 
  display:flex; 
  flex-direction:column; 
  position:relative; 
  overflow:hidden; 
  cursor:pointer;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--shadow);
}
.card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:3px;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
  transform:scaleX(0);
  transition:transform .3s;
}
.card::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(30,144,255,.05), rgba(13,17,23,.05));
  opacity:0;
  transition:opacity .3s;
}
.card:hover{
  transform:translateY(-8px) scale(1.02);
  border-color:var(--accent);
  box-shadow:0 12px 40px rgba(30,144,255,.3), 0 0 0 1px var(--accent);
}
.card:hover::before{
  transform:scaleX(1);
}
.card:hover::after{
  opacity:1;
}
.card .top-row{ 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  margin-bottom:12px; 
  position:relative;
  z-index:1;
}
.card .name{ 
  font-weight:900; 
  color:var(--text); 
  font-size:16px; 
  text-overflow:ellipsis; 
  white-space:nowrap; 
  overflow:hidden; 
  max-width:85%;
  letter-spacing:0.5px;
}
.img-wrap{ 
  flex:1 1 auto; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  padding:12px; 
  background: rgba(0,0,0,.2); 
  border-radius:12px; 
  margin-bottom:12px; 
  min-height:140px; 
  position:relative;
  z-index:1;
  border: 2px solid rgba(30,144,255,.4);
  box-shadow: inset 0 0 12px rgba(30,144,255,.2), 0 0 16px rgba(30,144,255,.3);
}
.img-wrap img{ 
  width:100%; 
  height:140px; 
  object-fit:contain; 
  display:block; 
  filter:drop-shadow(0 4px 12px rgba(0,0,0,.5));
  border-radius: 8px;
}

/* rarity badge - Forum Tag Style */
.badge{ 
  position:absolute; 
  left:16px; 
  bottom:16px; 
  padding:8px 14px; 
  border-radius:8px; 
  font-weight:900; 
  color:#fff; 
  border:1px solid rgba(255,255,255,.2); 
  font-size:11px; 
  text-transform:uppercase;
  letter-spacing:1px;
}
.badge.common{background:linear-gradient(135deg, rgba(173,216,230,.9), rgba(135,206,250,.9));color:#000;border-color:#4a90e2;}
.badge.uncommon{background:linear-gradient(135deg, rgba(34,177,76,.9), rgba(76,175,80,.9));color:#fff;}
.badge.rare{background:linear-gradient(135deg, rgba(255,193,7,.9), rgba(255,211,0,.9));color:#000;border-color:#fdd835;}
.badge.epic{background:linear-gradient(135deg, rgba(255,87,34,.9), rgba(255,112,67,.9));color:#fff;}
.badge.legendary{background:linear-gradient(135deg, rgba(244,67,54,.9), rgba(229,57,53,.9));color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:2;}

/* turf map */
.turf-map { width:100%; height:460px; border-radius:12px; overflow:hidden; background:linear-gradient(180deg, rgba(0,0,0,.12), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.04); box-shadow: 0 20px 60px rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; }
.turf-map img{ width:100%; height:100%; object-fit:cover; }

/* acquired list */
.acquired-heading{ margin-top:18px; font-weight:900; color:var(--accent); }
.acquired-grid{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; }

/* modals */
.modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); z-index:9999; }
.modal-overlay.open{ display:flex; }
.modal{ width:920px; max-width:96%; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); box-shadow: 0 22px 60px rgba(0,0,0,.6); }

/* weapon popup (Killadelphia-style) */
.weapon-popup {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}
.weapon-popup.hidden { display:none; }
.weapon-popup-inner {
  width: 80%;
  max-width: 980px;
  background: linear-gradient(180deg, rgba(20,20,25,0.95), rgba(10,10,12,0.92));
  border-radius: 14px;
  padding: 20px;
  color: white;
  box-shadow: 0 0 50px rgba(0,0,0,0.5);
}
.weapon-popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.weapon-popup-header h2 { font-size:24px; margin:0; font-weight:900; color:var(--accent); }
.rarity-tag { padding:6px 12px; border-radius:999px; font-weight:900; font-size:13px; color:#fff; background:rgba(255,255,255,0.06); }
.weapon-popup-body { display:flex; gap:16px; align-items:flex-start; }
.weapon-popup-image { width:300px; height:300px; object-fit:contain; background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(255,255,255,0)); border-radius:12px; padding:12px; }
.weapon-stats-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:12px; flex:1; }
.stat-card { background:rgba(0,0,0,0.35); padding:14px; border-radius:10px; }
.stat-title { color:var(--muted); font-weight:800; font-size:12px; }
.stat-value { font-weight:900; font-size:18px; margin-top:6px; color:#fff; }

/* Victory Frame */
.victory-overlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(30, 144, 255, 0.15) 0%, rgba(0, 0, 0, 0.97) 70%);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  animation: victoryFadeIn 0.15s ease-out;
}

@keyframes victoryFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.victory-card {
  position: relative;
  background: linear-gradient(135deg, rgba(26, 10, 10, 0.98) 0%, rgba(10, 5, 5, 0.98) 50%, rgba(18, 6, 18, 0.98) 100%);
  border: 3px solid transparent;
  border-radius: 20px;
  padding: 0;
  max-width: 1000px;
  width: 95%;
  text-align: center;
  box-shadow: 0 20px 80px rgba(30, 144, 255, 0.4), 0 0 2px rgba(30, 144, 255, 0.8), inset 0 0 40px rgba(30, 144, 255, 0.08);
  animation: victoryScale 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  overflow: hidden;
  max-height: 90vh;
  overflow-y: auto;
}

.victory-card::before {
  content: '';
  position: absolute;
  inset: 0;
  padding: 3px;
  border-radius: 20px;
  background: linear-gradient(135deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  opacity: 0.8;
  pointer-events: none;
}

@keyframes victoryScale {
  0% {
    opacity: 0;
    transform: scale(0.8) translateY(30px) translateZ(0);
  }
  100% {
    opacity: 1;
    transform: scale(1) translateY(0) translateZ(0);
  }
}

.victory-header {
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.3) 0%, rgba(13, 17, 23, 0.2) 50%, rgba(30, 144, 255, 0.3) 100%);
  padding: 24px;
  border-bottom: 2px solid transparent;
  border-image: linear-gradient(90deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%) 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

.victory-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(13, 17, 23, 0.05));
  pointer-events: none;
}

.victory-header h2 {
  margin: 0;
  font-size: 42px;
  font-weight: 900;
  background: linear-gradient(135deg, #4a9eff 0%, #4682b4 50%, #4a9eff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 20px rgba(255, 71, 87, 0.6));
  letter-spacing: 3px;
  position: relative;
  z-index: 1;
}

.victory-count {
  font-size: 18px;
  font-weight: 800;
  color: rgba(255, 255, 255, 0.8);
  background: rgba(0, 0, 0, 0.3);
  padding: 8px 16px;
  border-radius: 20px;
  letter-spacing: 1px;
}

.victory-content {
  padding: 30px 20px;
}

.victory-items-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  max-width: 900px;
  margin: 0 auto;
}

.victory-item {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(0, 0, 0, 0.3) 100%);
  border: 2px solid transparent;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: all 0.15s ease;
  animation: victoryItemAppear 0.2s ease-out backwards;
  position: relative;
  overflow: hidden;
}

.victory-item::before {
  content: '';
  position: absolute;
  inset: 0;
  padding: 2px;
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.4) 0%, rgba(13, 17, 23, 0.4) 100%);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  pointer-events: none;
}

@keyframes victoryItemAppear {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(5px) translateZ(0);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0) translateZ(0);
  }
}

.victory-item:nth-child(1) { animation-delay: 0.03s; }
.victory-item:nth-child(2) { animation-delay: 0.06s; }
.victory-item:nth-child(3) { animation-delay: 0.09s; }
.victory-item:nth-child(4) { animation-delay: 0.12s; }
.victory-item:nth-child(5) { animation-delay: 0.15s; }
.victory-item:nth-child(6) { animation-delay: 0.18s; }

.victory-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(30, 144, 255, 0.5), 0 0 20px rgba(13, 17, 23, 0.3);
}

.victory-item:hover::before {
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.7) 0%, rgba(13, 17, 23, 0.7) 100%);
}

.victory-image-container {
  position: relative;
  width: 180px;
  height: 180px;
  margin-bottom: 15px;
  background: linear-gradient(135deg, rgba(30, 144, 255, 0.2) 0%, rgba(13, 17, 23, 0.2) 100%);
  border: 2px solid transparent;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 25px rgba(30, 144, 255, 0.4), inset 0 0 30px rgba(0, 0, 0, 0.3);
  animation: victoryImagePulse 2s ease-in-out infinite;
  overflow: hidden;
}

.victory-image-container::before {
  content: '';
  position: absolute;
  inset: 0;
  padding: 2px;
  border-radius: 16px;
  background: linear-gradient(135deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  pointer-events: none;
}

@keyframes victoryImagePulse {
  0%, 100% {
    box-shadow: 0 0 25px rgba(30, 144, 255, 0.4), inset 0 0 30px rgba(0, 0, 0, 0.3);
  }
  50% {
    box-shadow: 0 0 35px rgba(30, 144, 255, 0.6), 0 0 20px rgba(13, 17, 23, 0.4), inset 0 0 30px rgba(0, 0, 0, 0.3);
  }
}

.victory-image-container img {
  max-width: 85%;
  max-height: 85%;
  object-fit: contain;
  filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.5));
}

.victory-item-name {
  font-size: 18px;
  font-weight: 900;
  color: #ffffff;
  margin: 10px 0 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: center;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.victory-item-rarity {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 6px;
  font-weight: 800;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
}

.victory-item-rarity.common {
  background: linear-gradient(135deg, #808080, #606060);
  color: #ffffff;
}

.victory-item-rarity.uncommon {
  background: linear-gradient(135deg, #10b981, #047857);
  color: #ffffff;
}

.victory-item-rarity.rare {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  color: #ffffff;
}

.victory-item-rarity.epic {
  background: linear-gradient(135deg, #a855f7, #7e22ce);
  color: #ffffff;
}

.victory-item-rarity.legendary {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #ffffff;
}

.victory-item-rarity.special {
  background: linear-gradient(135deg, #ff6b35, #1e90ff);
  color: #ffffff;
  animation: rarityGlow 1.5s ease-in-out infinite;
}

@keyframes rarityGlow {
  0%, 100% {
    box-shadow: 0 4px 15px rgba(30, 144, 255, 0.5);
  }
  50% {
    box-shadow: 0 4px 25px rgba(30, 144, 255, 0.9);
  }
}

.victory-item-desc {
  color: #b0b8c0;
  font-size: 15px;
  margin-top: 15px;
  font-style: italic;
  line-height: 1.5;
}

.victory-collect-btn {
  width: calc(100% - 60px);
  margin: 0 30px 30px;
  padding: 18px;
  font-size: 20px;
  font-weight: 900;
  background: linear-gradient(135deg, #1e90ff, #4a9eff);
  color: #ffffff;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 3px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px rgba(30, 144, 255, 0.5);
}

.victory-collect-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(30, 144, 255, 0.7);
  background: linear-gradient(135deg, #4a9eff, #1e90ff);
}

.victory-collect-btn:active {
  transform: translateY(0);
}

/* ========== MOBILE RESPONSIVE ========== */
@media(max-width:980px){ 
  .weapon-popup-body{flex-direction:column; align-items:center;} 
  .weapon-popup-image{width:220px;height:220px;} 
  .title{font-size:32px;} 
  .logo{width:70px;height:70px;}
  .grid{grid-template-columns: repeat(auto-fill, minmax(150px,1fr));} 
  .victory-items-grid{grid-template-columns: repeat(2, 1fr) !important; gap:15px;} 
  .victory-image-container{width:150px;height:150px;} 
  .victory-header h2{font-size:32px;} 
  .victory-header{flex-direction:column; gap:10px;} 
  .victory-count{font-size:14px;} 
  .container{padding:14px;}
  .topnav .cat{padding:8px 12px; font-size:13px;}
  .btn{padding:8px 12px; font-size:13px;}
}

@media(max-width:640px){ 
  html,body{padding:10px;}
  .wrap{padding:0;}
  .container{padding:12px; border-radius:12px;}
  .header{flex-direction:column; align-items:flex-start;}
  .header-left{max-width:100%;}
  .header-right{width:100%; justify-content:flex-end;}
  .logo{width:60px;height:60px;}
  .title{font-size:24px;}
  .subtitle{font-size:13px;}
  .topnav{gap:6px;}
  .topnav .cat{padding:7px 10px; font-size:12px;}
  .subtabs .sub{padding:6px 10px; font-size:12px;}
  .controls{flex-wrap:wrap; gap:8px;}
  .controls .left{flex:1; min-width:100%;}
  .drop-actions{width:100%; justify-content:flex-end;}
  .btn{padding:7px 10px; font-size:12px;}
  select{padding:6px 8px; font-size:12px;}
  .grid{grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap:10px;} 
  .card{padding:8px; min-height:160px;}
  .card .name{font-size:13px;}
  .img-wrap{min-height:90px; padding:4px;}
  .weapon-popup-inner{width:96%; padding:16px;} 
  .weapon-popup-image{width:160px;height:160px;} 
  .weapon-popup-header h2{font-size:18px;}
  .stat-card{padding:10px;}
  .stat-title{font-size:11px;}
  .stat-value{font-size:16px;}
  .modal{padding:16px; max-height:85vh; overflow-y:auto;}
  .victory-card{width:98%; max-width:100%; padding:16px;} 
  .victory-items-grid{grid-template-columns: 1fr !important; gap:10px;} 
  .victory-image-container{width:120px;height:120px;} 
  .victory-header h2{font-size:20px;} 
  .victory-item-name{font-size:14px;} 
  .victory-content{padding:16px 12px;} 
  .victory-item{padding:12px;} 
  .victory-collect-btn{padding:12px; font-size:14px;}
  #landedGunDisplay{padding:12px; margin-top:12px;}
  #landedGunDisplay img{max-width:80px; max-height:60px;}
  #landedGunName{font-size:16px;}
  #landedGunRarity{font-size:12px;}
}

@media(max-width:400px){ 
  html,body{padding:8px;}
  .container{padding:10px;}
  .title{font-size:20px;}
  .logo{width:50px;height:50px;}
  .topnav .cat{padding:6px 8px; font-size:11px;}
  .btn{padding:6px 8px; font-size:11px;}
  .grid{grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:8px;} 
  .card{padding:6px; min-height:140px;}
  .card .name{font-size:12px;}
  .img-wrap{min-height:75px;}
  .victory-header h2{font-size:18px;} 
  .victory-item-name{font-size:13px;} 
  .victory-collect-btn{padding:10px; font-size:13px;}
}
</style>
</head>
<body>
 
  <!-- Background video (muted) -->
  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="video.mp4" type="video/mp4">
  </video>
  <div id="bgDark" aria-hidden="true"></div>
  <img id="bgEmblem" src="TFB.png" alt="" aria-hidden="true">

  <div class="wrap">
    <div class="header">
      <div class="header-left">
        <h1 class="title">The Five Borough Illegal Factions</h1>
        <div class="subtitle">Illegal Factions</div>

        <div class="topnav" id="mainNav">
          <div class="cat active" data-tab="testdrops"><i class="fa-solid fa-bullseye"></i>&nbsp;Test Drops</div>
          <div class="cat" data-tab="tier1"><i class="fa-solid fa-gun"></i>&nbsp;Tier 1 Weaponry</div>
          <div class="cat" data-tab="tier1_5"><i class="fa-solid fa-star"></i>&nbsp;Tier 1.5</div>
          <div class="cat" data-tab="tier2"><i class="fa-solid fa-shield-alt"></i>&nbsp;Tier 2 Weaponry</div>
          <div class="cat" data-tab="drugs"><i class="fa-solid fa-capsules"></i>&nbsp;Drugs</div>
          <div class="cat" data-tab="forums"><i class="fa-solid fa-comments"></i>&nbsp;Forums</div>
          <div class="cat" data-tab="roe"><i class="fa-solid fa-book"></i>&nbsp;ROE</div>
        </div>

        <div class="subtabs" id="subtabs"></div>
      </div>

      <div class="header-right">
        <div id="musicToggle" class="music-toggle" title="Toggle Music"><i class="fa-solid fa-volume-high"></i>&nbsp;<span id="musicLabel">Music: On</span></div>
        <div id="userProfile" class="user-profile" style="display:none; cursor:pointer;" title="User Profile">
          <i class="fa-solid fa-user-circle"></i>&nbsp;<span id="userDisplayName">Guest</span>
        </div>
        <div class="logo"><img src="TFB.png" class="header-logo" alt="TFB logo"></div>
      </div>
    </div>

    <div class="container">
      <div class="controls">
        <div class="left">
          <div class="choose">Filter</div>
          <select id="filterSelect">
            <option value="all">All</option>
            <option value="common">Common</option>
            <option value="uncommon">Uncommon</option>
            <option value="rare">Rare</option>
            <option value="epic">Epic</option>
            <option value="legendary">Legendary</option>
          </select>
        </div>

        <div class="drop-actions">
          <button class="btn" id="viewDropsBtn"><i class="fa-solid fa-list"></i>&nbsp;Drops</button>
          <button class="btn drop" id="dropBtn"><i class="fa-solid fa-dice"></i>&nbsp;DROP</button>
        </div>
      </div>

      <div id="contentArea">
        <div class="grid-wrap">
          <div class="grid" id="itemGrid" aria-live="polite"></div>
        </div>
      </div>

      <div class="acquired-heading">Acquired Items</div>
      <div class="acquired-grid" id="acquiredGrid"></div>

      <div style="display:flex; gap:12px; margin-top:14px; align-items:flex-start; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px;">
          <div class="info-panel" id="infoPanel">Click a card to preview more info. Use DROP to open the spin modal and receive a weighted drop.</div>
        </div>
        <div style="width:320px;">
          <div class="info-panel">
            <div style="font-weight:900">Made By Route</div>
            <div style="color:var(--muted); margin-top:8px;" id="lastUpdated">Last updated: —</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>
    <div class="footer"><div>© The Five Borough Illegal Factions</div><div style="color:var(--muted)">Built with ❤️</div></div>
  </div>

  <!-- Spin modal -->
  <div class="modal-overlay" id="spinModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; font-size:18px;">Spin Wheel</div>
        <div style="color:var(--muted); font-weight:800;">Click SPIN to start</div>
      </div>

      <div style="position:relative; margin-top:12px;">
        <div id="spinStrip" style="height:140px; display:flex; gap:12px; align-items:center; overflow:hidden; padding:10px;"></div>
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:6px; height:120px; border-radius:6px; background:linear-gradient(180deg, #ff0000, #1e90ff); box-shadow: 0 0 30px rgba(255,0,0,.8), 0 0 15px rgba(255,0,0,1); pointer-events:none;"></div>
      </div>

      <!-- Display for landed gun -->
      <div id="landedGunDisplay" style="display:none; margin-top:16px; padding:16px; background:rgba(0,0,0,.6); border:2px solid rgba(30,144,255,.5); border-radius:10px; text-align:center;">
        <div style="font-weight:900; color:var(--accent); margin-bottom:8px;">YOU GOT:</div>
        <div style="display:flex; align-items:center; justify-content:center; gap:16px;">
          <img id="landedGunImage" src="" style="max-width:100px; max-height:80px; object-fit:contain;">
          <div>
            <div id="landedGunName" style="font-weight:900; font-size:18px; color:white;"></div>
            <div id="landedGunRarity" style="font-weight:700; font-size:14px; margin-top:4px;"></div>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn" id="closeSpin">Close</button>
        <button class="btn drop" id="spinStartBtn">SPIN</button>
      </div>
    </div>
  </div>

  <!-- Victory Frame -->
  <div id="victoryFrame" class="victory-overlay" style="display:none;">
    <div class="victory-card">
      <div class="victory-header">
        <h2 id="victoryHeaderText">YOU GOT:</h2>
        <div class="victory-count" id="victoryCount">4 ITEMS</div>
      </div>
      <div class="victory-content">
        <div class="victory-items-grid" id="victoryItemsGrid">
          <!-- Items will be inserted here dynamically -->
        </div>
      </div>
      <button class="victory-collect-btn" id="victoryCollectBtn">COLLECT ALL</button>
    </div>
  </div>

  <!-- weapon popup -->
  <div id="weaponPopup" class="weapon-popup hidden" aria-hidden="true">
    <div class="weapon-popup-inner" role="dialog" aria-modal="true">
      <div class="weapon-popup-header">
        <h2 id="weaponPopupName">Weapon</h2>
        <div id="weaponPopupRarity" class="rarity-tag">COMMON</div>
      </div>

      <div class="weapon-popup-body">
        <img id="weaponPopupImage" class="weapon-popup-image" src="" alt="weapon image">
        <div class="weapon-stats-grid">
          <div class="stat-card stat-card-1 stat-card-large">
            <div class="stat-title">Damage</div>
            <div id="statDamage" class="stat-value">-</div>
          </div>
          <div class="stat-card stat-card-2 stat-card-large">
            <div class="stat-title">Fire Rate</div>
            <div id="statFire" class="stat-value">-</div>
          </div>
          <div class="stat-card stat-card-3">
            <div class="stat-title">Ammo</div>
            <div id="statAmmo" class="stat-value">-</div>
          </div>
          <div class="stat-card stat-card-4">
            <div class="stat-title">Magazine</div>
            <div id="statMagazine" class="stat-value">-</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button class="btn" onclick="closeWeaponPopup()">Close</button>
      </div>
    </div>
  </div>

  <!-- stats modal (fallback) -->
  <div class="modal-overlay" id="statsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div id="statsTitle" style="font-weight:900;"></div>
        <button class="btn" id="closeStats"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <div style="flex:0 0 220px; height:140px; border-radius:10px; overflow:hidden; background:rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center;">
          <img id="statsImg" src="" alt="" style="max-width:100%; max-height:100%; object-fit:contain;">
        </div>
        <div style="flex:1;">
          <div id="statsRarity" style="color:var(--muted); font-weight:900;"></div>
          <div id="statsDetails" style="margin-top:12px; color:var(--muted);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- background audio (extracted) -->
  <audio id="bgm" src="background_audio.mp3" loop preload="auto"></audio>

<script>
/* Single-file Quaker City (Option B) */

/* ============= SUPABASE CONFIGURATION ============= */
// TODO: Replace these with your actual Supabase credentials
// Get them from: https://supabase.com → Your Project → Settings → API
const SUPABASE_URL = 'https://nuspjghelmpqwvbxienl.supabase.co'; // CORRECTED: Your actual API URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51c3BqZ2hlbG1wcXd2YnhpZW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTcxNDcsImV4cCI6MjA4MDkzMzE0N30.SMEYGk_cNoGW8IVRlj9nBU_aKWbzOcwf_rv_9ydvyxQ'; // Your anon/public key

let supabase;
let useSupabase = false; // Will auto-enable when credentials are set
let threadCache = null;
let threadCacheTime = 0;
const CACHE_DURATION = 30000; // Cache threads for 30 seconds

// Initialize Supabase if credentials are provided
if (SUPABASE_URL && SUPABASE_ANON_KEY && SUPABASE_URL.includes('.supabase.co')) {
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    useSupabase = true;
    console.log('✅ Supabase connected - Forum data will be synced globally');
  } catch (e) {
    console.warn('Supabase initialization failed, using localStorage:', e);
  }
} else {
  console.warn('⚠️ Supabase not configured - Using localStorage (device-specific data)');
  console.warn('To enable global sync: Add your Supabase credentials in the code');
}

/* =========================================================
   BASE PATH — GITHUB PAGES COMPATIBILITY
   ========================================================= */
// Automatically detect if running locally or on GitHub Pages
const BASE_PATH = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:' 
  ? '.' 
  : '/TFB-Illegal-Factions';

console.log('BASE_PATH:', BASE_PATH);
console.log('Location:', window.location.hostname, window.location.protocol);

/* =========================================================
   IMAGE MAP — VALID GUNS ONLY (39 TOTAL)
   ========================================================= */

const IMAGES = {
  '1911': BASE_PATH + '/Gunimage/1911.png',
  '38_revolver': BASE_PATH + '/Gunimage/38_revolver.png',
  'GH': BASE_PATH + '/Gunimage/GH.png',
  'M_P9': BASE_PATH + '/Gunimage/M_P9.png',
  'Tri_11s': BASE_PATH + '/Gunimage/Tri_11s.png',
  'artic_hcat': BASE_PATH + '/Gunimage/artic_hcat.png',
  'bape_glock': BASE_PATH + '/Gunimage/bape_glock.png',
  'black_p80': BASE_PATH + '/Gunimage/black_p80.png',
  'fn57': BASE_PATH + '/Gunimage/fn57.png',
  'fnx45': BASE_PATH + '/Gunimage/fnx45.png',
  'g17_arma': BASE_PATH + '/Gunimage/g17_arma.png',
  'g19_flex': BASE_PATH + '/Gunimage/g19_flex.png',
  'g19_foregrip': BASE_PATH + '/Gunimage/g19_foregrip.png',
  'g20': BASE_PATH + '/Gunimage/g20.png',
  'g20_switch': BASE_PATH + '/Gunimage/g20_switch.png',
  'g21': BASE_PATH + '/Gunimage/g21.png',
  'g23': BASE_PATH + '/Gunimage/g23.png',
  'g26_switch': BASE_PATH + '/Gunimage/g26_switch.png',
  'g30': BASE_PATH + '/Gunimage/g30.png',
  'g40': BASE_PATH + '/Gunimage/g40.png',
  'g43x': BASE_PATH + '/Gunimage/g43x.png',
  'g45': BASE_PATH + '/Gunimage/g45.png',
  'g45x': BASE_PATH + '/Gunimage/g45x.png',
  'g48': BASE_PATH + '/Gunimage/g48.png',
  'gflex': BASE_PATH + '/Gunimage/gflex.png',
  'gg45': BASE_PATH + '/Gunimage/gg45.png',
  'hellcat': BASE_PATH + '/Gunimage/hellcat.png',
  'hipoint': BASE_PATH + '/Gunimage/hipoint.png',
  'keltec': BASE_PATH + '/Gunimage/keltec.png',
  'm9': BASE_PATH + '/Gunimage/m9.png',
  'mac10': BASE_PATH + '/Gunimage/mac10.png',
  'psa_dagger': BASE_PATH + '/Gunimage/psa_dagger.png',
  'ruger57': BASE_PATH + '/Gunimage/ruger57.png',
  'sig_p320': BASE_PATH + '/Gunimage/sig_p320.png',
  'sr40': BASE_PATH + '/Gunimage/sr40.png',
  'tan_19x': BASE_PATH + '/Gunimage/tan_19x.png',
  'tarkov_gspc': BASE_PATH + '/Gunimage/tarkov_gspc.png',
  'tec9': BASE_PATH + '/Gunimage/tec9.png',
  
  // New Weapons - Common (Black & White / Green)
  'callous': BASE_PATH + '/Gunimage/WEAPON_CALLOUS.png', // 1911
  'g17g5': BASE_PATH + '/Gunimage/WEAPON_G17G5.png',
  'hk45': BASE_PATH + '/Gunimage/WEAPON_HK45.png',
  'g43g': BASE_PATH + '/Gunimage/WEAPON_G43G.png',
  'dcomb': BASE_PATH + '/Gunimage/WEAPON_DCOMB.png', // G19X
  'g233': BASE_PATH + '/Gunimage/WEAPON_G233.png',
  'g40_common': BASE_PATH + '/Gunimage/WEAPON_G40.png',
  'sigcb': BASE_PATH + '/Gunimage/WEAPON_SIGCB.png', // SIG P320
  'p88p': BASE_PATH + '/Gunimage/WEAPON_P88P.png', // Walther P88
  'cpt': BASE_PATH + '/Gunimage/WEAPON_CPT.png', // Glock 45x
  
  // New Weapons - Rare (Pink / Purple)
  'fn57': BASE_PATH + '/Gunimage/WEAPON_FFN.png', // .45 ACP FN 57
  'g45': BASE_PATH + '/Gunimage/WEAPON_OLIVEG19.png', // G45 (renamed from oliveg19)
  
  // New Weapons - Epic (Orange)
  'ap3': BASE_PATH + '/Gunimage/WEAPON_AP3.png', // G23 Switch
  '45mos': BASE_PATH + '/Gunimage/WEAPON_45MOS.png', // G45 MOS
  '43mos': BASE_PATH + '/Gunimage/WEAPON_43MOS.png', // G43 MOS
  '19switch': BASE_PATH + '/Gunimage/WEAPON_19SWITCH.png', // G19 Switch
  'mac10_new': BASE_PATH + '/Gunimage/WEAPON_MAC10.png',
  'fnx45_new': BASE_PATH + '/Gunimage/WEAPON_FNX45.png',
  'g40_epic': BASE_PATH + '/Gunimage/WEAPON_G40.png', // Alt Skin
  
  // New Weapons - Legendary (Red)
  'dracoz': BASE_PATH + '/Gunimage/WEAPON_DRACOZ.png',
  'draco2': BASE_PATH + '/Gunimage/WEAPON_DRACO2.png', // Olive Draco
  'arpsh': BASE_PATH + '/Gunimage/WEAPON_ARPSH.png', // ARP Binary
  
  // Drug images
  'Weed': BASE_PATH + '/Gunimage/weed.png',
  'Shrooms': BASE_PATH + '/Gunimage/Shrooms.png',
  'Xanax': BASE_PATH + '/images/Xanax.png',
  'Perc 20s': BASE_PATH + '/Gunimage/perc20.png',
  'Perc 30s': BASE_PATH + '/Gunimage/perc30.png',
  'Green': BASE_PATH + '/Gunimage/Green Syrup.png',
  'Tris': BASE_PATH + '/images/Tris.png',
  'Quagen': BASE_PATH + '/images/Quagen.png',
  'Wockhardt': BASE_PATH + '/Gunimage/Wock.png',
  'PCP': BASE_PATH + '/Gunimage/pcp.png'
};

// Debug: Log some image paths
console.log('Sample image paths:');
console.log('callious:', IMAGES['callious']);
console.log('g17g5:', IMAGES['g17g5']);
console.log('dracoz:', IMAGES['dracoz']);

/* ---------------- FALLBACK IMAGE ---- */
const FALLBACK =
  'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="240"%3E%3Crect fill="%23333" width="400" height="240"/%3E%3Ctext x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';

/* ---------------- WEAPON STATS (updated damage by rarity) — 39 VALID GUNS ONLY ---- */
const WEAPON_STATS = {
  /* ---- COMMON (Green background - new olive green guns) ---- */
  'callous': { damage: 24, fire: 500, ammo: '.45 ACP', magStd: 7, magExt: 14 },
  'g17g5': { damage: 25, fire: 730, ammo: '9mm', magStd: 17, magExt: 34 },
  'hk45': { damage: 27, fire: 650, ammo: '.45 ACP', magStd: 10, magExt: 20 },
  'g43g': { damage: 25, fire: 700, ammo: '9mm', magStd: 10, magExt: 20 },
  'dcomb': { damage: 25, fire: 700, ammo: '9mm', magStd: 19, magExt: 38 },
  'g233': { damage: 25, fire: 760, ammo: '.40 S&W', magStd: 13, magExt: 26 },
  'g40_common': { damage: 29, fire: 650, ammo: '10mm', magStd: 15, magExt: 30 },
  'sigcb': { damage: 25, fire: 770, ammo: '9mm', magStd: 17, magExt: 34 },
  'p88p': { damage: 25, fire: 720, ammo: '9mm', magStd: 15, magExt: 30 },
  'cpt': { damage: 25, fire: 700, ammo: '9mm', magStd: 14, magExt: 28 },
  
  /* ---- UNCOMMON (Black/White background - old guns) ---- */
  '1911': { damage: 24, fire: 500, ammo: '.45 ACP', magStd: 7, magExt: 14 },
  '38_revolver': { damage: 22, fire: 450, ammo: '.38 Special', magStd: 6, magExt: 12 },
  'GH': { damage: 25, fire: 550, ammo: '9mm', magStd: 8, magExt: 16 },
  'M_P9': { damage: 25, fire: 750, ammo: '9mm', magStd: 15, magExt: 30 },
  'Tri_11s': { damage: 25, fire: 750, ammo: '9mm', magStd: 12, magExt: 24 },
  'bape_glock': { damage: 24, fire: 600, ammo: '9mm', magStd: 15, magExt: 30 },
  'black_p80': { damage: 25, fire: 740, ammo: '9mm', magStd: 18, magExt: 36 },
  'g20': { damage: 25, fire: 730, ammo: '9mm', magStd: 16, magExt: 32 },
  'g23': { damage: 25, fire: 760, ammo: '.45 ACP', magStd: 13, magExt: 26 },
  'g43x': { damage: 25, fire: 700, ammo: '9mm', magStd: 10, magExt: 20 },
  'g45': { damage: 25, fire: 740, ammo: '9mm', magStd: 10, magExt: 20 },
  'g48': { damage: 25, fire: 700, ammo: '9mm', magStd: 10, magExt: 20 },
  'hellcat': { damage: 24, fire: 700, ammo: '9mm', magStd: 11, magExt: 22 },
  'sig_p320': { damage: 25, fire: 770, ammo: '9mm', magStd: 17, magExt: 34 },
  'artic_hcat': { damage: 25, fire: 720, ammo: '9mm', magStd: 15, magExt: 30 },
  'fn57': { damage: 21, fire: 600, ammo: '5.7x28mm', magStd: 20, magExt: 40 },
  'g19_foregrip': { damage: 25, fire: 700, ammo: '9mm', magStd: 15, magExt: 30 },
  'g21': { damage: 27, fire: 680, ammo: '.45 ACP', magStd: 13, magExt: 26 },
  'g30': { damage: 28, fire: 650, ammo: '.45 ACP', magStd: 10, magExt: 20 },
  'gflex': { damage: 26, fire: 700, ammo: '9mm', magStd: 13, magExt: 26 },
  'hipoint': { damage: 20, fire: 400, ammo: '.45 ACP', magStd: 8, magExt: 16 },
  'm9': { damage: 25, fire: 650, ammo: '9mm', magStd: 15, magExt: 30 },
  'gg45': { damage: 28, fire: 680, ammo: '.45 ACP', magStd: 11, magExt: 22 },
  'g45x': { damage: 25, fire: 700, ammo: '9mm', magStd: 14, magExt: 28 },
  
  /* ---- RARE (Yellow old + Pink/Purple new) ---- */
  'fnx45': { damage: 27, fire: 680, ammo: '.45 ACP', magStd: 15, magExt: 30 },
  'g19_flex': { damage: 25, fire: 700, ammo: '9mm', magStd: 15, magExt: 30 },
  'g20_switch': { damage: 27, fire: 680, ammo: '10mm', magStd: 15, magExt: 30 },
  'g26_switch': { damage: 24, fire: 680, ammo: '9mm', magStd: 10, magExt: 20 },
  'g40': { damage: 29, fire: 650, ammo: '10mm', magStd: 15, magExt: 30 },
  'keltec': { damage: 21, fire: 600, ammo: '9mm', magStd: 6, magExt: 12 },
  'mac10': { damage: 28, fire: 1050, ammo: '.45 ACP', magStd: 30, magExt: 42 },
  'psa_dagger': { damage: 32, fire: 850, ammo: '9mm', magStd: 20, magExt: 40 },
  'ruger57': { damage: 23, fire: 620, ammo: '5.7x28mm', magStd: 20, magExt: 40 },
  'sr40': { damage: 27, fire: 700, ammo: '.40 S&W', magStd: 15, magExt: 30 },
  'tan_19x': { damage: 25, fire: 700, ammo: '9mm', magStd: 19, magExt: 38 },
  'tarkov_gspc': { damage: 31, fire: 800, ammo: '9mm', magStd: 18, magExt: 36 },
  
  /* ---- EPIC (Orange background) ---- */
  'ap3': { damage: 30, fire: 850, ammo: '.40 S&W', magStd: 13, magExt: 26 },
  '45mos': { damage: 28, fire: 740, ammo: '9mm', magStd: 17, magExt: 34 },
  '43mos': { damage: 30, fire: 700, ammo: '9mm', magStd: 10, magExt: 20 },
  '19switch': { damage: 30, fire: 850, ammo: '9mm', magStd: 33, magExt: 50 },
  'mac10_new': { damage: 28, fire: 1050, ammo: '.45 ACP', magStd: 30, magExt: 42 },
  'fnx45_new': { damage: 27, fire: 680, ammo: '.45 ACP', magStd: 15, magExt: 30 },
  'g40_epic': { damage: 32, fire: 650, ammo: '10mm', magStd: 15, magExt: 30 },
  
  /* ---- LEGENDARY (Red background) ---- */
  'tec9': { damage: 40, fire: 1200, ammo: '9mm', magStd: 32, magExt: 50 },
  'dracoz': { damage: 45, fire: 650, ammo: '7.62x39mm', magStd: 30, magExt: 75 },
  'draco2': { damage: 45, fire: 650, ammo: '7.62x39mm', magStd: 30, magExt: 75 },
  'arpsh': { damage: 42, fire: 850, ammo: '5.56x45mm', magStd: 30, magExt: 60 }
};

/* ---------------- DRUG PRICES ---------------- */
const DRUG_PRICES = {
  'Weed': { price: '$200–$750' },
  'Shrooms': { price: '$500–$750' },
  'Xanax': { price: '$700–$1,100' },
  'Perc 20s': { price: '$700–$1,000' },
  'Perc 30s': { price: '$1,200–$2,500' },
  'Green': { price: '$900–$1,800' },
  'Tris': { price: '$2,000–$3,500' },
  'Quagen': { price: '$3,500–$6,500' },
  'Wockhardt': { price: '$4,000–$7,000' },
  'PCP': { price: '$7,000–$10,000' }
};

/* ------------ ITEMS DATASET (39 VALID GUNS ONLY) ------------ */
const ITEMS = {
  testdrops: [
    // Common - Green background (new olive green guns)
    { name:'g17g5', rarity:'common', category:'Pistols', img:IMAGES['g17g5'] || FALLBACK },
    { name:'hk45', rarity:'common', category:'Pistols', img:IMAGES['hk45'] || FALLBACK },
    { name:'g43g', rarity:'common', category:'Pistols', img:IMAGES['g43g'] || FALLBACK },
    { name:'dcomb', rarity:'common', category:'Pistols', img:IMAGES['dcomb'] || FALLBACK },
    { name:'g233', rarity:'common', category:'Pistols', img:IMAGES['g233'] || FALLBACK },
    { name:'sigcb', rarity:'common', category:'Pistols', img:IMAGES['sigcb'] || FALLBACK },
    { name:'p88p', rarity:'common', category:'Pistols', img:IMAGES['p88p'] || FALLBACK },
    { name:'cpt', rarity:'common', category:'Pistols', img:IMAGES['cpt'] || FALLBACK },
    
    // Uncommon - Black/White background (old guns only)
    { name:'38_revolver', rarity:'uncommon', category:'Pistols', img:IMAGES['38_revolver'] || FALLBACK },
    { name:'GH', rarity:'uncommon', category:'Pistols', img:IMAGES['GH'] || FALLBACK },
    { name:'black_p80', rarity:'uncommon', category:'Pistols', img:IMAGES['black_p80'] || FALLBACK },
    { name:'g20', rarity:'uncommon', category:'Pistols', img:IMAGES['g20'] || FALLBACK },
    { name:'g23', rarity:'uncommon', category:'Pistols', img:IMAGES['g23'] || FALLBACK },
    { name:'g43x', rarity:'uncommon', category:'Pistols', img:IMAGES['g43x'] || FALLBACK },
    { name:'g48', rarity:'uncommon', category:'Pistols', img:IMAGES['g48'] || FALLBACK },
    { name:'hellcat', rarity:'uncommon', category:'Pistols', img:IMAGES['hellcat'] || FALLBACK },
    { name:'sig_p320', rarity:'uncommon', category:'Pistols', img:IMAGES['sig_p320'] || FALLBACK },
    { name:'artic_hcat', rarity:'uncommon', category:'Pistols', img:IMAGES['artic_hcat'] || FALLBACK },
    { name:'hipoint', rarity:'uncommon', category:'Pistols', img:IMAGES['hipoint'] || FALLBACK },
    { name:'m9', rarity:'uncommon', category:'Pistols', img:IMAGES['m9'] || FALLBACK },
    { name:'gg45', rarity:'uncommon', category:'Pistols', img:IMAGES['gg45'] || FALLBACK },
    { name:'g45x', rarity:'uncommon', category:'Pistols', img:IMAGES['g45x'] || FALLBACK }
  ],
  
  tier1: [
    // Common - Green background (new olive green guns)
    { name:'g17g5', rarity:'common', category:'Pistols', img:IMAGES['g17g5'] || FALLBACK },
    { name:'hk45', rarity:'common', category:'Pistols', img:IMAGES['hk45'] || FALLBACK },
    { name:'g43g', rarity:'common', category:'Pistols', img:IMAGES['g43g'] || FALLBACK },
    { name:'dcomb', rarity:'common', category:'Pistols', img:IMAGES['dcomb'] || FALLBACK },
    { name:'g233', rarity:'common', category:'Pistols', img:IMAGES['g233'] || FALLBACK },
    { name:'sigcb', rarity:'common', category:'Pistols', img:IMAGES['sigcb'] || FALLBACK },
    { name:'g40_common', rarity:'common', category:'Pistols', img:IMAGES['g40_common'] || FALLBACK },
    { name:'p88p', rarity:'common', category:'Pistols', img:IMAGES['p88p'] || FALLBACK },
    { name:'cpt', rarity:'common', category:'Pistols', img:IMAGES['cpt'] || FALLBACK },
    
    // Uncommon - 1 random uncommon gun
    { name:'artic_hcat', rarity:'uncommon', category:'Pistols', img:IMAGES['artic_hcat'] || FALLBACK },
    
    // Rare - All old yellow guns
    { name:'g19_flex', rarity:'rare', category:'Pistols', img:IMAGES['g19_flex'] || FALLBACK },
    { name:'psa_dagger', rarity:'rare', category:'Pistols', img:IMAGES['psa_dagger'] || FALLBACK },
    { name:'tan_19x', rarity:'rare', category:'Pistols', img:IMAGES['tan_19x'] || FALLBACK },
    { name:'tarkov_gspc', rarity:'rare', category:'Pistols', img:IMAGES['tarkov_gspc'] || FALLBACK }
  ],
  
  tier1_5: [
    // Common - 2 green guns
    { name:'hk45', rarity:'common', category:'Pistols', img:IMAGES['hk45'] || FALLBACK },
    { name:'dcomb', rarity:'common', category:'Pistols', img:IMAGES['dcomb'] || FALLBACK },
    
    // Rare - All old yellow guns
    { name:'fnx45', rarity:'rare', category:'Pistols', img:IMAGES['fnx45'] || FALLBACK },
    { name:'g19_flex', rarity:'rare', category:'Pistols', img:IMAGES['g19_flex'] || FALLBACK },
    { name:'g20_switch', rarity:'rare', category:'Pistols', img:IMAGES['g20_switch'] || FALLBACK },
    { name:'g26_switch', rarity:'rare', category:'Pistols', img:IMAGES['g26_switch'] || FALLBACK },
    { name:'g40', rarity:'rare', category:'Pistols', img:IMAGES['g40'] || FALLBACK },
    { name:'keltec', rarity:'rare', category:'Pistols', img:IMAGES['keltec'] || FALLBACK },
    { name:'mac10', rarity:'rare', category:'SMG', img:IMAGES['mac10'] || FALLBACK },
    { name:'psa_dagger', rarity:'rare', category:'Pistols', img:IMAGES['psa_dagger'] || FALLBACK },
    { name:'ruger57', rarity:'rare', category:'Pistols', img:IMAGES['ruger57'] || FALLBACK },
    { name:'sr40', rarity:'rare', category:'Pistols', img:IMAGES['sr40'] || FALLBACK },
    { name:'tan_19x', rarity:'rare', category:'Pistols', img:IMAGES['tan_19x'] || FALLBACK },
    { name:'tarkov_gspc', rarity:'rare', category:'Pistols', img:IMAGES['tarkov_gspc'] || FALLBACK },
    
    // Epic - All orange guns (old + new)
    { name:'ap3', rarity:'epic', category:'Pistols', img:IMAGES['ap3'] || FALLBACK },
    { name:'45mos', rarity:'epic', category:'Pistols', img:IMAGES['45mos'] || FALLBACK },
    { name:'43mos', rarity:'epic', category:'Pistols', img:IMAGES['43mos'] || FALLBACK },
    { name:'19switch', rarity:'epic', category:'Pistols', img:IMAGES['19switch'] || FALLBACK },
    { name:'mac10_new', rarity:'epic', category:'SMG', img:IMAGES['mac10_new'] || FALLBACK },
    { name:'fnx45_new', rarity:'epic', category:'Pistols', img:IMAGES['fnx45_new'] || FALLBACK },
    { name:'g40_epic', rarity:'epic', category:'Pistols', img:IMAGES['g40_epic'] || FALLBACK }
  ],
  
  tier2: [
    // Epic - All orange guns (old + new)
    { name:'bape_glock', rarity:'epic', category:'Pistols', img:IMAGES['bape_glock'] || FALLBACK },
    { name:'ap3', rarity:'epic', category:'Pistols', img:IMAGES['ap3'] || FALLBACK },
    { name:'45mos', rarity:'epic', category:'Pistols', img:IMAGES['45mos'] || FALLBACK },
    { name:'43mos', rarity:'epic', category:'Pistols', img:IMAGES['43mos'] || FALLBACK },
    { name:'19switch', rarity:'epic', category:'Pistols', img:IMAGES['19switch'] || FALLBACK },
    { name:'mac10_new', rarity:'epic', category:'SMG', img:IMAGES['mac10_new'] || FALLBACK },
    { name:'fnx45_new', rarity:'epic', category:'Pistols', img:IMAGES['fnx45_new'] || FALLBACK },
    { name:'g40_epic', rarity:'epic', category:'Pistols', img:IMAGES['g40_epic'] || FALLBACK },
    
    // Legendary - All red guns (old + new)
    { name:'tec9', rarity:'legendary', category:'Pistols', img:IMAGES['tec9'] || FALLBACK },
    { name:'dracoz', rarity:'legendary', category:'Rifles', img:IMAGES['dracoz'] || FALLBACK },
    { name:'draco2', rarity:'legendary', category:'Rifles', img:IMAGES['draco2'] || FALLBACK },
    { name:'arpsh', rarity:'legendary', category:'Rifles', img:IMAGES['arpsh'] || FALLBACK }
  ],
  
  drugs: [
    { name:'Weed', rarity:'common', category:'Common', img:IMAGES['Weed'] || FALLBACK },
    { name:'Shrooms', rarity:'common', category:'Common', img:IMAGES['Shrooms'] || FALLBACK },
    { name:'Xanax', rarity:'uncommon', category:'Uncommon', img:IMAGES['Xanax'] || FALLBACK },
    { name:'Perc 20s', rarity:'uncommon', category:'Uncommon', img:IMAGES['Perc 20s'] || FALLBACK },
    { name:'Perc 30s', rarity:'rare', category:'Rare', img:IMAGES['Perc 30s'] || FALLBACK },
    { name:'Green', rarity:'rare', category:'Rare', img:IMAGES['Green'] || FALLBACK },
    { name:'Tris', rarity:'epic', category:'Epic', img:IMAGES['Tris'] || FALLBACK },
    { name:'Quagen', rarity:'epic', category:'Epic', img:IMAGES['Quagen'] || FALLBACK },
    { name:'Wockhardt', rarity:'legendary', category:'Legendary', img:IMAGES['Wockhardt'] || FALLBACK },
    { name:'PCP', rarity:'legendary', category:'Legendary', img:IMAGES['PCP'] || FALLBACK }
  ]
};

// Debug: Check what's in the testdrops
console.log('ITEMS.testdrops count:', ITEMS.testdrops.length);
console.log('First 5 testdrops:', ITEMS.testdrops.slice(0, 5));
console.log('Last 5 testdrops:', ITEMS.testdrops.slice(-5));

/* weights */
const DEFAULT_WEIGHTS = {
  testdrops: { common:40, uncommon:60 },
  tier1: { common:97, uncommon:0, rare:3 },
  tier1_5: { common:0, uncommon:15, rare:35, epic:35, legendary:15 },
  tier2: { common:10, uncommon:30, rare:30, epic:20, legendary:10 },
  drugs: { common:35, uncommon:25, rare:25, epic:15 }
};

/* ---------- DOM refs ---------- */
let itemGrid = document.getElementById('itemGrid'); // let so can rebind
const contentArea = document.getElementById('contentArea');
const subtabsEl = document.getElementById('subtabs');
const filterSelect = document.getElementById('filterSelect');
const dropBtn = document.getElementById('dropBtn');
const viewDropsBtn = document.getElementById('viewDropsBtn');
const acquiredGrid = document.getElementById('acquiredGrid');
const spinModal = document.getElementById('spinModal');
const spinStrip = document.getElementById('spinStrip');
const spinStartBtn = document.getElementById('spinStartBtn');
const closeSpin = document.getElementById('closeSpin');
const landedGunDisplay = document.getElementById('landedGunDisplay');
const landedGunImage = document.getElementById('landedGunImage');
const landedGunName = document.getElementById('landedGunName');
const landedGunRarity = document.getElementById('landedGunRarity');

const musicToggle = document.getElementById('musicToggle');
const musicLabel = document.getElementById('musicLabel');
const bgm = document.getElementById('bgm');
if(bgm) bgm.volume = 0.4; // Set background music to 40% volume

const userProfile = document.getElementById('userProfile');
const userDisplayName = document.getElementById('userDisplayName');

const statsModal = document.getElementById('statsModal');
const statsTitle = document.getElementById('statsTitle');
const statsImg = document.getElementById('statsImg');
const statsRarity = document.getElementById('statsRarity');
const statsDetails = document.getElementById('statsDetails');
const closeStats = document.getElementById('closeStats');

const weaponPopup = document.getElementById('weaponPopup');
const weaponPopupName = document.getElementById('weaponPopupName');
const weaponPopupRarity = document.getElementById('weaponPopupRarity');
const weaponPopupImage = document.getElementById('weaponPopupImage');
const statDamage = document.getElementById('statDamage');
const statFire = document.getElementById('statFire');
const statAmmo = document.getElementById('statAmmo');
const statMagazine = document.getElementById('statMagazine');

let activeTab = 'testdrops';
let activeSub = 'All';
let acquired = [];
let spinning = false;

/* ---------- helpers & optimization ---------- */
const tick = ms => new Promise(r=> setTimeout(r,ms));
const rand = arr => arr[Math.floor(Math.random()*arr.length)];
const loadCfg = () => { try{return JSON.parse(localStorage.getItem('qc_cfg')||'{}')}catch(e){return{}} };
const saveCfg = c => localStorage.setItem('qc_cfg', JSON.stringify(c));
const getWeights = () => { const c = loadCfg(); return c.weights || DEFAULT_WEIGHTS; };
const setWeights = w => { const c = loadCfg(); c.weights = w; saveCfg(c); };

/* Debounce/Throttle utilities */
const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } };
const throttle = (fn, ms) => { let last = 0; return (...a) => { const now = Date.now(); if (now - last >= ms) { fn(...a); last = now; } } };

/* ============= SUPABASE DATABASE FUNCTIONS ============= */
async function getThreadsFromDB() {
  if (!useSupabase) {
    return JSON.parse(localStorage.getItem('forum_threads') || '[]');
  }
  
  try {
    const { data, error } = await supabase
      .from('threads')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    return data || [];
  } catch (e) {
    console.error('Error fetching threads:', e);
    return JSON.parse(localStorage.getItem('forum_threads') || '[]');
  }
}

// Forums are read-only - no save/update operations needed

/* ---------- user profile ---------- */
function updateUserProfile(){
  const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
  if(currentUser){
    userProfile.style.display = 'inline-flex';
    userDisplayName.textContent = currentUser.username;
  } else {
    userProfile.style.display = 'none';
  }
}

if(userProfile){
  userProfile.addEventListener('click', ()=>{
    const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
    if(currentUser){
      showUserProfileModal(currentUser);
    }
  });
}

/* ---------- subtabs sets ---------- */
const SUBTABS = {
  testdrops: ['All','Pistols','SMG'],
  tier1: ['All','Pistols','SMG'],
  tier1_5: ['All','Pistols','SMG'],
  tier2: ['All','Pistols','SMG'],
  drugs: ['All','Common','Rare'],
  roe: ['All']
};
function renderSubtabs(tab){
  const arr = SUBTABS[tab] || ['All'];
  const fragment = document.createDocumentFragment();
  const arrLen = arr.length;
  for(let i = 0; i < arrLen; i++){
    const s = arr[i];
    const el = document.createElement('div');
    el.className = i === 0 ? 'sub active' : 'sub';
    el.textContent = s;
    el.dataset.sub = s;
    fragment.appendChild(el);
  }
  subtabsEl.innerHTML = '';
  subtabsEl.appendChild(fragment);
  activeSub = arr[0];
  
  // Update filter dropdown (same options for all tabs)
  if(filterSelect.children.length === 0) {
    filterSelect.innerHTML = `
      <option value="all">All</option>
      <option value="common">Common</option>
      <option value="uncommon">Uncommon</option>
      <option value="rare">Rare</option>
      <option value="epic">Epic</option>
    `;
  }
}

/* ---------- filtering ---------- */
function itemsForTab(tab){
  const all = ITEMS[tab];
  if(!all || all.length === 0) return [];
  
  const filter = filterSelect.value;
  const subLower = activeSub ? activeSub.toLowerCase() : 'all';
  
  let res = all;
  if(filter !== 'all') {
    res = res.filter(i => i.rarity === filter);
  }
  
  if(subLower !== 'all'){
    res = res.filter(i=>{
      const cat = (i.category||'').toLowerCase();
      if(subLower === 'smg') return cat.includes('smg');
      if(subLower === 'pistols') return cat.includes('pist');
      return cat.includes(subLower);
    });
  }
  return res;
}

/* create card (clean) */
function createCard(item){
  const el = document.createElement('div');
  el.className = 'card';
  const rarity = (item.rarity||'common').toLowerCase();
  el.innerHTML = `
    <div class="top-row"><div class="name">${item.name}</div></div>
    <div class="img-wrap"><img loading="lazy" src="${item.img}" alt="${item.name}" onerror="this.src='${FALLBACK}'"></div>
    <div style="height:8px"></div>
    <div class="badge ${rarity}">${rarity.toUpperCase()}</div>
  `;
  el.addEventListener('click', ()=> openWeaponPopupFromCard(item));
  return el;
}

/* render grid */
async function renderGrid(forceRefresh = false){
  const nodes = itemsForTab(activeTab);

  // Handle Forums tab
  if(activeTab === 'forums'){
    const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
    const allThreads = await getThreadsFromDB(forceRefresh);
    
    if(!currentUser){
      // Show login/register screen
      contentArea.innerHTML = `
        <div style="max-width:600px; margin:40px auto; padding:24px;">
          <div style="background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.5)); border:2px solid var(--accent); border-radius:16px; padding:40px; backdrop-filter:blur(12px);">
            <h2 style="color:var(--accent); font-weight:900; font-size:32px; margin-bottom:24px; text-align:center;">
              <i class="fa-solid fa-user-lock"></i> Forum Access
            </h2>
            
            <div id="authTabs" style="display:flex; gap:10px; margin-bottom:24px; justify-content:center;">
              <button class="btn drop" id="showLogin" style="padding:12px 24px;">Login</button>
              <button class="btn" id="showRegister" style="padding:12px 24px;">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
              <div style="margin-bottom:16px;">
                <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Username</label>
                <input type="text" id="loginUsername" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,.4); color:var(--text); font-family:inherit;" placeholder="Enter username">
              </div>
              <div style="margin-bottom:24px;">
                <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Password</label>
                <input type="password" id="loginPassword" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,.4); color:var(--text); font-family:inherit;" placeholder="Enter password">
              </div>
              <button class="btn drop" id="loginBtn" style="width:100%; padding:14px; font-size:16px;">Login</button>
              <div id="loginError" style="color:#ff4444; margin-top:12px; text-align:center; display:none;"></div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
              <div style="margin-bottom:16px;">
                <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Username</label>
                <input type="text" id="regUsername" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,.4); color:var(--text); font-family:inherit;" placeholder="Choose username">
              </div>
              <div style="margin-bottom:16px;">
                <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Password</label>
                <input type="password" id="regPassword" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,.4); color:var(--text); font-family:inherit;" placeholder="Choose password">
              </div>
              <div style="margin-bottom:24px;">
                <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Confirm Password</label>
                <input type="password" id="regConfirm" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,.4); color:var(--text); font-family:inherit;" placeholder="Confirm password">
              </div>
              <button class="btn drop" id="registerBtn" style="width:100%; padding:14px; font-size:16px;">Create Account</button>
              <div id="registerError" style="color:#ff4444; margin-top:12px; text-align:center; display:none;"></div>
            </div>
          </div>
        </div>
      `;

      // Auth tab switching
      document.getElementById('showLogin').addEventListener('click', () => {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('showLogin').classList.add('drop');
        document.getElementById('showRegister').classList.remove('drop');
      });
      document.getElementById('showRegister').addEventListener('click', () => {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('showLogin').classList.remove('drop');
        document.getElementById('showRegister').classList.add('drop');
      });

      // Login handler
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const users = await getUsersFromDB();
        const user = users.find(u => u.username === username && u.password === password);
        
        if(user){
          localStorage.setItem('forum_current_user', JSON.stringify({username: user.username}));
          updateUserProfile();
          renderGrid();
        } else {
          const err = document.getElementById('loginError');
          err.textContent = 'Invalid username or password';
          err.style.display = 'block';
        }
      });

      // Register handler
      document.getElementById('registerBtn').addEventListener('click', async () => {
        const username = document.getElementById('regUsername').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirm = document.getElementById('regConfirm').value;
        const err = document.getElementById('registerError');
        
        if(!username || !password){
          err.textContent = 'Please fill all fields';
          err.style.display = 'block';
          return;
        }
        if(password !== confirm){
          err.textContent = 'Passwords do not match';
          err.style.display = 'block';
          return;
        }
        
        const users = await getUsersFromDB();
        if(users.find(u => u.username === username)){
          err.textContent = 'Username already exists';
          err.style.display = 'block';
          return;
        }
        
        await saveUserToDB({username, password});
        localStorage.setItem('forum_current_user', JSON.stringify({username}));
        updateUserProfile();
        renderGrid();
      });
      
      return;
    }

    // User is logged in - show forums with card-based categories
    contentArea.innerHTML = `
      <div style="max-width:1200px; margin:0 auto; padding:24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px;">
          <div>
            <h2 style="color:var(--accent); font-weight:900; font-size:32px; margin:0;">
              <i class="fa-solid fa-comments"></i> TFB Forums
            </h2>
            <div style="color:var(--muted); margin-top:8px;">Welcome, <strong style="color:var(--accent);">${currentUser.username}</strong></div>
          </div>
          <div style="display:flex; gap:12px;">
            <button class="btn" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;Logout</button>
          </div>
        </div>

        <!-- Forum Categories Grid -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-bottom:40px;">
          <!-- General Discussion -->
          <div class="forum-category-card" style="background:linear-gradient(135deg, rgba(30, 144, 255, 0.15) 0%, rgba(26, 26, 26, 0.95) 100%); border:2px solid rgba(30, 144, 255, 0.3); border-radius:16px; padding:24px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--accent)'; this.style.boxShadow='0 12px 40px rgba(30, 144, 255, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(30, 144, 255, 0.3)'; this.style.boxShadow='none';">
            <div style="position:absolute; top:-20px; right:-20px; font-size:100px; opacity:0.1; color:var(--accent);">
              <i class="fa-solid fa-messages"></i>
            </div>
            <div style="position:relative; z-index:1;">
              <div style="font-size:40px; color:var(--accent); margin-bottom:16px;">
                <i class="fa-solid fa-messages"></i>
              </div>
              <h3 style="color:var(--text); font-weight:900; font-size:22px; margin:0 0 12px 0;">General Discussion</h3>
              <p style="color:var(--muted); font-size:14px; margin:0 0 16px 0; line-height:1.6;">Talk about anything related to TFB, gameplay, strategies, and more.</p>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:var(--accent); font-weight:700; font-size:14px;">${allThreads.filter(t => t.threadType === 'General').length} Threads</span>
                <i class="fa-solid fa-arrow-right" style="color:var(--accent);"></i>
              </div>
            </div>
          </div>

          <!-- Illegal Schemes -->
          <div class="forum-category-card" style="background:linear-gradient(135deg, rgba(13, 17, 23, 0.15) 0%, rgba(26, 26, 26, 0.95) 100%); border:2px solid rgba(13, 17, 23, 0.3); border-radius:16px; padding:24px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#0d1117'; this.style.boxShadow='0 12px 40px rgba(13, 17, 23, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(13, 17, 23, 0.3)'; this.style.boxShadow='none';">
            <div style="position:absolute; top:-20px; right:-20px; font-size:100px; opacity:0.1; color:#0d1117;">
              <i class="fa-solid fa-mask"></i>
            </div>
            <div style="position:relative; z-index:1;">
              <div style="font-size:40px; color:#4a9eff; margin-bottom:16px;">
                <i class="fa-solid fa-mask"></i>
              </div>
              <h3 style="color:var(--text); font-weight:900; font-size:22px; margin:0 0 12px 0;">Illegal Schemes</h3>
              <p style="color:var(--muted); font-size:14px; margin:0 0 16px 0; line-height:1.6;">Submit and discuss scammer, racer, and drug dealer schemes.</p>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#4a9eff; font-weight:700; font-size:14px;">${allThreads.filter(t => ['Scammer', 'Racer', 'Drug Dealer'].includes(t.schemeType)).length} Threads</span>
                <i class="fa-solid fa-arrow-right" style="color:#4a9eff;"></i>
              </div>
            </div>
          </div>

          <!-- Weapon Drops -->
          <div class="forum-category-card" style="background:linear-gradient(135deg, rgba(255, 165, 0, 0.15) 0%, rgba(26, 26, 26, 0.95) 100%); border:2px solid rgba(255, 165, 0, 0.3); border-radius:16px; padding:24px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#ffa500'; this.style.boxShadow='0 12px 40px rgba(255, 165, 0, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255, 165, 0, 0.3)'; this.style.boxShadow='none';">
            <div style="position:absolute; top:-20px; right:-20px; font-size:100px; opacity:0.1; color:#ffa500;">
              <i class="fa-solid fa-gun"></i>
            </div>
            <div style="position:relative; z-index:1;">
              <div style="font-size:40px; color:#ffa500; margin-bottom:16px;">
                <i class="fa-solid fa-gun"></i>
              </div>
              <h3 style="color:var(--text); font-weight:900; font-size:22px; margin:0 0 12px 0;">Weapon Drops</h3>
              <p style="color:var(--muted); font-size:14px; margin:0 0 16px 0; line-height:1.6;">Share your best weapon drops and discuss gun stats.</p>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#ffa500; font-weight:700; font-size:14px;">${allThreads.filter(t => t.threadType === 'Weapons').length} Threads</span>
                <i class="fa-solid fa-arrow-right" style="color:#ffa500;"></i>
              </div>
            </div>
          </div>

          <!-- Rules & Guides -->
          <div class="forum-category-card" style="background:linear-gradient(135deg, rgba(138, 43, 226, 0.15) 0%, rgba(26, 26, 26, 0.95) 100%); border:2px solid rgba(138, 43, 226, 0.3); border-radius:16px; padding:24px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#8a2be2'; this.style.boxShadow='0 12px 40px rgba(138, 43, 226, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(138, 43, 226, 0.3)'; this.style.boxShadow='none';">
            <div style="position:absolute; top:-20px; right:-20px; font-size:100px; opacity:0.1; color:#8a2be2;">
              <i class="fa-solid fa-book"></i>
            </div>
            <div style="position:relative; z-index:1;">
              <div style="font-size:40px; color:#8a2be2; margin-bottom:16px;">
                <i class="fa-solid fa-book"></i>
              </div>
              <h3 style="color:var(--text); font-weight:900; font-size:22px; margin:0 0 12px 0;">Rules & Guides</h3>
              <p style="color:var(--muted); font-size:14px; margin:0 0 16px 0; line-height:1.6;">Server rules, ROE, and helpful guides for new players.</p>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#8a2be2; font-weight:700; font-size:14px;">${allThreads.filter(t => t.threadType === 'Rules').length} Threads</span>
                <i class="fa-solid fa-arrow-right" style="color:#8a2be2;"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Threads -->
        <div style="margin-top:40px;">
          <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:20px; border-bottom:2px solid rgba(30, 144, 255, 0.3); padding-bottom:12px;">
            <i class="fa-solid fa-clock"></i> Recent Threads
          </h3>
          <div id="threadList">
            ${allThreads.length === 0 ? `
              <div style="background:rgba(80,80,80,.5); border:1px solid var(--glass-border); border-radius:12px; padding:40px; text-align:center; color:var(--muted);">
                <i class="fa-solid fa-inbox" style="font-size:48px; margin-bottom:16px; display:block;"></i>
                <div style="font-size:18px; font-weight:700;">No threads yet</div>
              </div>
            ` : allThreads.slice(0, 10).map((thread, idx) => `
              <div class="thread-card" data-idx="${idx}" style="background:linear-gradient(180deg,rgba(30,30,30,.8),rgba(20,20,20,.9)); border:1px solid var(--glass-border); border-radius:12px; padding:20px; margin-bottom:16px; cursor:pointer; transition:all .2s;" onmouseover="this.style.borderColor='var(--accent)'; this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 16px rgba(30, 144, 255, 0.3)';" onmouseout="this.style.borderColor='var(--glass-border)'; this.style.transform='translateX(0)'; this.style.boxShadow='none';">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                  <div>
                    <h3 style="color:var(--text); font-weight:900; font-size:20px; margin:0 0 8px 0;">${thread.title}</h3>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                      <span style="background:rgba(30,144,255,.2); color:var(--accent); padding:4px 12px; border-radius:6px; font-size:12px; font-weight:700;"><i class="fa-solid fa-tag"></i> ${thread.schemeType}</span>
                      <span style="background:rgba(13,17,23,.2); color:#4a9eff; padding:4px 12px; border-radius:6px; font-size:12px; font-weight:700;"><i class="fa-solid fa-folder"></i> ${thread.threadType}</span>
                    </div>
                  </div>
                  <div style="text-align:right;">
                    <div style="color:var(--muted); font-size:13px;">by <strong style="color:var(--accent);">${thread.author}</strong></div>
                    <div style="color:var(--muted); font-size:12px; margin-top:4px;"><i class="fa-solid fa-calendar"></i> ${new Date(thread.date).toLocaleDateString()}</div>
                  </div>
                </div>
                ${thread.videoUrl ? `<div style="color:var(--muted); font-size:14px;"><i class="fa-solid fa-video" style="color:var(--accent); margin-right:6px;"></i>Contains video</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('forum_current_user');
      updateUserProfile();
      renderGrid();
    });

    // Thread click handlers - use event delegation
    contentArea.addEventListener('click', (e) => {
      const card = e.target.closest('.thread-card');
      if(card) {
        const idx = parseInt(card.dataset.idx);
        showThreadModal(allThreads[idx]);
      }
    });

    return;
  }

  // Handle Schemes tab
  if(activeTab === 'schemes'){
    contentArea.innerHTML = `
      <div style="max-width:1000px; margin:0 auto; padding:24px;">
        <div style="background:linear-gradient(135deg, rgba(26, 10, 10, 0.95) 0%, rgba(10, 5, 20, 0.95) 50%, rgba(10, 10, 26, 0.95) 100%); border:3px solid transparent; border-radius:20px; padding:32px; backdrop-filter:blur(12px); box-shadow: 0 10px 40px rgba(30, 144, 255, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5); position:relative; overflow:hidden;">
          <div style="position:absolute; inset:0; padding:3px; border-radius:20px; background:linear-gradient(135deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity:0.6; pointer-events:none;"></div>
          <h2 style="color:var(--text); font-weight:900; font-size:32px; margin-bottom:24px; text-align:center; background:linear-gradient(135deg, #4a9eff 0%, #4682b4 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; filter:drop-shadow(0 0 15px rgba(30, 144, 255, 0.5)); position:relative; z-index:1;">
            <i class="fa-solid fa-file-pen"></i> Illegal Faction Scheme Submission Guidelines
          </h2>
          
          <div style="color:var(--text); line-height:1.8; font-size:16px;">
            <div style="background:linear-gradient(135deg, rgba(30, 144, 255, 0.15) 0%, rgba(13, 17, 23, 0.15) 100%); border:2px solid transparent; border-radius:12px; padding:24px; margin-bottom:28px; position:relative; overflow:hidden;">
              <div style="position:absolute; inset:0; padding:2px; border-radius:12px; background:linear-gradient(135deg, rgba(30, 144, 255, 0.6) 0%, rgba(13, 17, 23, 0.6) 100%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;"></div>
              <p style="margin:0 0 16px 0; font-weight:700; font-size:18px; position:relative; z-index:1;">
                Welcome to the thread submission channel for your illegal faction schemes! This is where all <strong style="color:var(--accent);">Scammer</strong>, <strong style="color:var(--accent);">Racer</strong>, and <strong style="color:var(--accent);">Drug Dealer</strong> threads must begin.
              </p>
              <p style="margin:0; color:var(--muted); position:relative; z-index:1;">
                Please read the guidelines carefully before submitting.
              </p>
            </div>

            <div style="margin-bottom:28px; position:relative; z-index:1;">
              <h3 style="color:var(--accent); font-weight:800; font-size:22px; margin-bottom:16px; border-bottom:2px solid transparent; border-image:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%) 1; padding-bottom:8px;">
                <i class="fa-solid fa-check-circle"></i> Submission Requirements
              </h3>
              <p style="margin-bottom:16px; color:var(--muted);">
                When you submit your thread, ensure you clearly include the following four pieces of information in your initial post:
              </p>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Thread Name/Title:</strong> Be specific and creative.
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Scheme Type:</strong> Clearly state if this is a <strong>Scammer</strong>, <strong>Racer</strong>, or <strong>Drug Dealer</strong> scheme.
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Thread Type:</strong> State whether it is an <strong>Individual (I)</strong> or <strong>Group (G)</strong> thread.
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Roleplay Focus:</strong> Describe the specific goal or scenario your roleplay will revolve around. Be creative and put effort into it!
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Eligibility:</strong> Ensure you are eligible for the Tier/Type you are requesting based on your character's current status and history.
                </li>
                <li style="padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Limit:</strong> Remember the Attack Limit on your chosen scheme (e.g., 1 or 2 per week).
                </li>
              </ul>
            </div>

            <div style="margin-bottom:24px; position:relative; z-index:1;">
              <h3 style="color:var(--accent); font-weight:800; font-size:22px; margin-bottom:16px; border-bottom:2px solid transparent; border-image:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%) 1; padding-bottom:8px;">
                <i class="fa-solid fa-arrow-right"></i> What Happens Next? (Ticket System)
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-star" style="position:absolute; left:8px; top:6px; font-size:8px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Review:</strong> A staff member will review your submission in this channel.
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-star" style="position:absolute; left:8px; top:6px; font-size:8px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Approval & Move:</strong> If your submission is accepted, staff will:
                  <ul style="list-style:none; padding:0; margin-top:8px; margin-left:20px;">
                    <li style="margin-bottom:8px; color:var(--muted);">• Place a check mark reaction (✅) on your submission post.</li>
                    <li style="margin-bottom:8px; color:var(--muted);">• Create a private ticket channel for your thread.</li>
                    <li style="color:var(--muted);">• Add you (and any listed participants) to that ticket channel.</li>
                  </ul>
                </li>
                <li style="margin-bottom:16px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-star" style="position:absolute; left:8px; top:6px; font-size:8px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Roleplay:</strong> Continue your thread only within the private ticket channel until the scenario is complete.
                </li>
                <li style="padding-left:24px; position:relative;">
                  <i class="fa-solid fa-star" style="position:absolute; left:8px; top:6px; font-size:8px; color:var(--accent);"></i>
                  <strong style="color:var(--accent);">Drops:</strong> The Illegal Faction Team + Management will track the Roleplay in the ticket and determine drops upon completion.
                </li>
              </ul>
            </div>

            <div style="background:linear-gradient(135deg, rgba(30, 144, 255, 0.2) 0%, rgba(13, 17, 23, 0.15) 100%); border-left:4px solid transparent; border-image:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%) 1; padding:20px; border-radius:8px; margin-top:32px; position:relative; z-index:1;">
              <p style="margin:0; font-weight:700; font-size:18px;">
                <i class="fa-solid fa-lightbulb"></i> <strong>Reminder:</strong>
              </p>
              <p style="margin:8px 0 0 0; color:var(--muted);">
                All submissions must follow these guidelines. Incomplete or unclear submissions may be rejected or delayed. 
                Put effort into your thread concept to ensure approval and great roleplay!
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
    return;
  }

  // Handle The Spot tab
  if(activeTab === 'spot'){
    contentArea.innerHTML = `
      <div style="max-width:1100px; margin:0 auto; padding:24px;">
        <div style="background:linear-gradient(135deg, rgba(26, 10, 10, 0.95) 0%, rgba(10, 5, 20, 0.95) 50%, rgba(10, 10, 26, 0.95) 100%); border:3px solid transparent; border-radius:20px; padding:40px; backdrop-filter:blur(16px); box-shadow: 0 10px 40px rgba(30,144,255,0.3), inset 0 0 50px rgba(0,0,0,0.5); position:relative; overflow:hidden;">
          <div style="position:absolute; inset:0; padding:3px; border-radius:20px; background:linear-gradient(135deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity:0.6; pointer-events:none;"></div>
          
          <!-- Header Section -->
          <div style="text-align:center; margin-bottom:36px; border-bottom:2px solid transparent; border-image:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%) 1; padding-bottom:28px; position:relative; z-index:1;">
            <div style="font-size:14px; color:var(--accent); font-weight:800; letter-spacing:3px; margin-bottom:12px;">
              <i class="fa-solid fa-bullhorn"></i> OFFICIAL ANNOUNCEMENT
            </div>
            <h2 style="color:var(--text); font-weight:900; font-size:42px; margin:0; background:linear-gradient(135deg, #4a9eff 0%, #4682b4 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; filter:drop-shadow(0 0 15px rgba(30, 144, 255, 0.5));">
              <i class="fa-solid fa-location-dot" style="color:var(--accent);"></i> The Spot
            </h2>
            <div style="color:var(--muted); font-size:18px; margin-top:12px; font-weight:700;">
              A New Player-Run Black Market System for Serious Roleplay
            </div>
          </div>

          <div style="color:var(--text); line-height:1.9; font-size:16px;">
            
            <!-- Quote Section -->
            <div style="background:rgba(0,0,0,0.5); border-left:5px solid var(--accent); padding:20px 24px; margin-bottom:32px; border-radius:8px; font-style:italic;">
              <p style="margin:0; color:var(--muted); font-size:17px; font-weight:600;">
                "In New York, everyone knows the rule:<br>
                If you want heavy items, you go out of town — Upstate, Jersey, PA, Connecticut.<br>
                NYC is watched, the blocks are hot, and nothing comes easy."
              </p>
            </div>

            <p style="margin-bottom:20px; color:var(--muted);">
              In FiveM, the map may be limited, but our creativity isn't. That's where <strong style="color:var(--accent);">The Spot</strong> comes in.
            </p>

            <p style="margin-bottom:32px; color:var(--muted);">
              Born from a conversation between <strong style="color:var(--accent);">Adxt</strong> and <strong style="color:var(--accent);">Walking</strong>, The Spot is designed to bring a realistic, immersive, street-driven experience to how civilians access guns and drugs — without relying on factions, menus, or NPCs.
            </p>

            <!-- What Is The Spot -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:26px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-fire"></i> What Is The Spot?
              </h3>
              
              <div style="background:rgba(30,144,255,0.08); border:2px solid rgba(30,144,255,0.3); border-radius:12px; padding:24px; margin-bottom:20px;">
                <p style="margin:0 0 16px 0; font-weight:700; font-size:18px; color:var(--text);">
                  <strong style="color:var(--accent);">The Spot is a fully player-run system.</strong>
                </p>
                <p style="margin:0; color:var(--muted);">
                  Instead of a ped, a location, or a crafting menu, Civ Management members will personally run The Spot, rotating through different areas of the city and handling drops face-to-face.
                </p>
              </div>

              <p style="margin-bottom:16px; color:var(--muted);">
                This creates a living, unpredictable black market where civilians must use:
              </p>

              <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:20px;">
                <div style="background:rgba(0,0,0,0.4); padding:14px; border-radius:10px; border:1px solid rgba(30,144,255,0.2);">
                  <i class="fa-solid fa-map" style="color:var(--accent); margin-right:8px;"></i>
                  <strong>Street knowledge</strong>
                </div>
                <div style="background:rgba(0,0,0,0.4); padding:14px; border-radius:10px; border:1px solid rgba(30,144,255,0.2);">
                  <i class="fa-solid fa-users" style="color:var(--accent); margin-right:8px;"></i>
                  <strong>Networking</strong>
                </div>
                <div style="background:rgba(0,0,0,0.4); padding:14px; border-radius:10px; border:1px solid rgba(30,144,255,0.2);">
                  <i class="fa-solid fa-user-secret" style="color:var(--accent); margin-right:8px;"></i>
                  <strong>Low-key movement</strong>
                </div>
                <div style="background:rgba(0,0,0,0.4); padding:14px; border-radius:10px; border:1px solid rgba(30,144,255,0.2);">
                  <i class="fa-solid fa-comments" style="color:var(--accent); margin-right:8px;"></i>
                  <strong>IC interactions</strong>
                </div>
                <div style="background:rgba(0,0,0,0.4); padding:14px; border-radius:10px; border:1px solid rgba(30,144,255,0.2); grid-column:1/-1;">
                  <i class="fa-solid fa-brain" style="color:var(--accent); margin-right:8px;"></i>
                  <strong>Smart roleplay</strong>
                </div>
              </div>

              <div style="background:rgba(30,144,255,0.15); border-left:4px solid var(--accent); padding:16px; border-radius:8px;">
                <p style="margin:0; font-weight:700; color:var(--text);">
                  Nothing is handed out. Everything must be earned.
                </p>
              </div>
            </div>

            <!-- Serious RP Only -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:26px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-theater-masks"></i> Serious RP Only
              </h3>
              
              <div style="background:rgba(13,17,23,0.1); border:2px solid rgba(13,17,23,0.4); border-radius:12px; padding:24px;">
                <p style="margin:0 0 16px 0; color:var(--muted);">
                  To keep quality high, <strong style="color:var(--accent);">The Spot is only available to players who consistently show strong, serious roleplay.</strong>
                </p>
                <p style="margin:0; color:var(--muted);">
                  During the beta phase, access will be limited to a selected group of top RP'ers who will help set the tone and shape the system.
                </p>
              </div>
            </div>

            <!-- What This Means for PD -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:26px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-shield-halved"></i> What This Means for PD
              </h3>
              
              <p style="margin-bottom:16px; color:var(--muted);">
                Because The Spot is run entirely by real players, police roleplay becomes more dynamic and realistic:
              </p>

              <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;">
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-video" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Surveillance</strong>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-comment-dots" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Rumor tracking</strong>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-handcuffs" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Interrogations</strong>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-file-contract" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Search warrants</strong>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-car" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Traffic stops</strong>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.1);">
                  <i class="fa-solid fa-chart-line" style="color:var(--accent); font-size:20px; display:block; margin-bottom:8px;"></i>
                  <strong style="font-size:14px;">Pattern recognition</strong>
                </div>
              </div>

              <div style="background:rgba(30,144,255,0.1); border:2px solid rgba(30,144,255,0.3); border-radius:10px; padding:18px;">
                <p style="margin:0; color:var(--muted); line-height:1.7;">
                  There are no automatic alerts, no scripted locations, and no guaranteed catches.<br>
                  <strong style="color:var(--accent);">If civilians slip up IC, they get caught. If they move smart, they stay safe.</strong>
                </p>
              </div>
            </div>

            <!-- A New Chapter -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:26px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-city"></i> A New Chapter for Civilian RP
              </h3>
              
              <p style="margin-bottom:16px; color:var(--muted);">
                The Spot is the first step in a larger civilian pipeline built around creative, authentic New York roleplay.
              </p>

              <p style="margin-bottom:16px; color:var(--muted);">
                It gives players a real path into the weapon and drug game — not shortcuts, not menus, but <strong style="color:var(--accent);">earned opportunities through RP, story, and connections.</strong>
              </p>

              <p style="margin:0; color:var(--muted);">
                As this system grows, those who show the strongest roleplay will always be the first to experience new features.
              </p>
            </div>

            <!-- Closing Statement -->
            <div style="background:linear-gradient(135deg, rgba(30, 144, 255, 0.15) 0%, rgba(13, 17, 23, 0.15) 100%); border:3px solid transparent; border-radius:16px; padding:32px; text-align:center; box-shadow:0 10px 30px rgba(30,144,255,0.3); position:relative; overflow:hidden;">
              <div style="position:absolute; inset:0; padding:3px; border-radius:16px; background:linear-gradient(135deg, rgba(30, 144, 255, 0.7) 0%, rgba(13, 17, 23, 0.7) 100%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;"></div>
              <h2 style="background:linear-gradient(135deg, #4a9eff 0%, #4682b4 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; filter:drop-shadow(0 0 15px rgba(30, 144, 255, 0.6)); font-weight:900; font-size:32px; margin:0 0 20px 0; position:relative; z-index:1;">
                Welcome to The Spot
              </h2>
              <div style="font-size:19px; color:var(--text); font-weight:700; line-height:1.8; margin-bottom:24px;">
                <div style="margin-bottom:8px;"><i class="fa-solid fa-check" style="color:var(--accent); margin-right:10px;"></i>Move smart.</div>
                <div style="margin-bottom:8px;"><i class="fa-solid fa-check" style="color:var(--accent); margin-right:10px;"></i>Stay lowkey.</div>
                <div><i class="fa-solid fa-check" style="color:var(--accent); margin-right:10px;"></i>Earn your lane.</div>
              </div>
              <div style="color:var(--muted); font-size:16px; font-weight:600; margin-top:24px; padding-top:20px; border-top:2px solid transparent; border-image:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%) 1; position:relative; z-index:1;">
                — Adxt & Walking
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
    return;
  }

  // Handle ROE tab
  if(activeTab === 'roe'){
    contentArea.innerHTML = `
      <div style="max-width:1100px; margin:0 auto; padding:24px;">
        <div style="background:linear-gradient(135deg, rgba(26, 10, 10, 0.95) 0%, rgba(10, 5, 20, 0.95) 50%, rgba(10, 10, 26, 0.95) 100%); border:3px solid transparent; border-radius:20px; padding:32px; backdrop-filter:blur(12px); box-shadow: 0 10px 40px rgba(30, 144, 255, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5); position:relative; overflow:hidden;">
          <div style="position:absolute; inset:0; padding:3px; border-radius:20px; background:linear-gradient(135deg, #1e90ff 0%, #0d1117 50%, #1e90ff 100%); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity:0.6; pointer-events:none;"></div>
          
          <h2 style="color:var(--text); font-weight:900; font-size:32px; margin-bottom:24px; text-align:center; background:linear-gradient(135deg, #4a9eff 0%, #4682b4 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; filter:drop-shadow(0 0 15px rgba(30, 144, 255, 0.5)); position:relative; z-index:1;">
            <i class="fa-solid fa-scale-balanced"></i> TFB 4.0 — Official Faction Roleplay Guidelines
          </h2>
          
          <div style="color:var(--text); line-height:1.8; font-size:15px; position:relative; z-index:1;">
            <div style="background:rgba(30, 144, 255, 0.1); border-left:4px solid var(--accent); padding:16px; border-radius:8px; margin-bottom:28px;">
              <p style="margin:0; color:var(--text); font-weight:700;">Welcome to TFB 4.0, a serious roleplay server focused on high-quality faction roleplay.</p>
              <p style="margin:8px 0 0 0; color:var(--muted);">By engaging in faction RP, you acknowledge and agree to all rules listed below. Breaking any rule may result in punishment or faction strikes.</p>
            </div>

            <!-- FACTION ATTACK RULES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-crosshairs"></i> FACTION ATTACK RULES
              </h3>
              
              <h4 style="color:#4a9eff; font-weight:800; font-size:18px; margin:20px 0 12px 0;">General Attack Limits</h4>
              <ul style="list-style:none; padding:0; margin:0 0 20px 0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Max 4 attackers per faction (unless defending on your own turf).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No attacks or robberies in the first/last 15 minutes of a server restart.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Minimum 3 negative interactions (fights, robbery, stabbing) are required before initiating a shootout.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Entering the death script = active attack.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Attacks must escalate realistically and organically.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Shooting in the air for RP is allowed, but no one can be injured.
                </li>
              </ul>

              <h4 style="color:#4a9eff; font-weight:800; font-size:18px; margin:20px 0 12px 0;">Kill Limits & Deathmatching</h4>
              <ul style="list-style:none; padding:0; margin:0 0 20px 0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If 4+ people are on a turf, you may perform a deathmatching attack (no pinpointing).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Maximum intentional kills per attack: 3 (marked in red).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Unintentional extra kills: last victim is revived, no refunds.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If you shoot back, you lose protection.
                </li>
              </ul>

              <h4 style="color:#4a9eff; font-weight:800; font-size:18px; margin:20px 0 12px 0;">Identification</h4>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Tog names count as pinpointing only if unmasked.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If a masked user is avoiding RP, they may be attacked.
                </li>
              </ul>
            </div>

            <!-- MISCELLANEOUS FACTION RULES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-list-check"></i> MISCELLANEOUS FACTION RULES
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  All attackers must be inside the gang menu.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Non-members cannot participate in faction attacks.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Reloading during an attack is prohibited.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Double attacking is only allowed if the enemy hasn't slid back within 72 hours.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  You cannot attack during cooldowns.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Attacks from supercars are restricted to Tier 2+ factions.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Solo attacks are allowed only against solo targets with valid RP.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If shot but not placed in death script, you may RP injuries.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Entering death script from gunfire = mandatory character kill.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Tier 2+ factions may attack every 12 hours.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Robbery cooldown: 4 hours.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Robbery requires 2 interactions unless strong reason exists (flashing money/guns/drugs).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Robbing on a turf = faction attack.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Probationary factions cannot backdoor.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  At least 3 interactions are required before any backdoor action.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  All conflict must be built through RP, not excuses.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If someone avoids RP on another faction's turf, you may kill them.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Failure to fear RP = punishments.
                </li>
              </ul>
            </div>

            <!-- ILLEGAL CIVILIAN RULES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-user-secret"></i> ILLEGAL CIVILIAN RULES
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Illegal civilians may roleplay from a hood but cannot participate in faction beef unless joining that faction.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Must have positive interactions to defend a faction.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Illegal civs should have their own storylines, not live on blocks all day.
                </li>
              </ul>
            </div>

            <!-- POOR ESCALATION / FORBIDDEN ACTIONS -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-ban"></i> POOR ESCALATION / FORBIDDEN ACTIONS
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Attacks from EVs, motorcycles, dirt bikes are forbidden (mopeds allowed).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Poor escalation leads to punishments.
                </li>
              </ul>
            </div>

            <!-- MUTUAL COMBAT RULES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-handshake-slash"></i> MUTUAL COMBAT RULES
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  When 5+ members from two factions meet in a hostile situation, it can escalate into faction conflict even in greenzones.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Max 8 members per faction (including allies) in brawls.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Do not linger on a turf for more than 10 minutes.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Hiding weapons with emotes = playing to win.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Non-participating faction members may not scout or spin enemy turf.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No beefing or shooting at public, promoted events.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Crosshair usage = immediate termination if proven.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Metagaming (Discord, streams, clips) = punishments or faction strikes.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Must stay in server 30 minutes after initiating an attack.
                </li>
              </ul>
            </div>

            <!-- ROLEPLAY DEVELOPMENT RULES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-book-open"></i> ROLEPLAY DEVELOPMENT RULES
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No faction activity until your faction has a thread.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Poor portrayal can lead to punishment.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No unnecessary local OOC.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Characters must be 72 hours old before participating in attacks.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  You may only take clothes/shoes, not inventory items, after knocking someone out.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Hackers/hitbox users in a faction will lead to consequences.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Public OOC toxicity = punishments.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Repeated turf provoking or greenzone provoking = strikes/closure.
                </li>
              </ul>
            </div>

            <!-- ENGAGEMENT & SHOOTOUT GUIDELINES -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-gun"></i> ENGAGEMENT & SHOOTOUT GUIDELINES
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No speed boosting or "100k or die" shooting.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Shooter POV with sound and 3 minutes must be provided if asked.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Must be recorded with GeForce/AMD, or Twitch/Kick VOD showing desktop/taskbar.
                </li>
              </ul>
            </div>

            <!-- WATER EVADING -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-water"></i> WATER EVADING
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No using water to escape police, factions, or to remove GSR.
                </li>
              </ul>
            </div>

            <!-- FACTION REPORTS -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-flag"></i> FACTION REPORTS
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Reports must be made within 48 hours.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  No revenge-motivated reports.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  If you have an active report, do not interact negatively with that faction.
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Factions under report review may be banned from selling guns/drugs.
                </li>
              </ul>
            </div>

            <!-- WEAPON LOGGING & REFILL POLICY -->
            <div style="margin-bottom:32px;">
              <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-clipboard-list"></i> WEAPON LOGGING & REFILL POLICY
              </h3>
              <ul style="list-style:none; padding:0; margin:0;">
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  Logged faction guns can be respawned after 3 days (not for test factions).
                </li>
                <li style="margin-bottom:12px; padding-left:24px; position:relative;">
                  <i class="fa-solid fa-circle" style="position:absolute; left:8px; top:8px; font-size:6px; color:var(--accent);"></i>
                  All guns must be logged. Unlogged firearms = bans/strikes.
                </li>
              </ul>
            </div>

            <div style="background:linear-gradient(135deg, rgba(30, 144, 255, 0.2) 0%, rgba(13, 17, 23, 0.15) 100%); border-left:4px solid transparent; border-image:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%) 1; padding:20px; border-radius:8px; margin-top:32px;">
              <p style="margin:0; font-weight:700; font-size:18px;">
                <i class="fa-solid fa-triangle-exclamation"></i> <strong>Remember:</strong>
              </p>
              <p style="margin:8px 0 0 0; color:var(--muted);">
                All rules must be followed strictly. Failure to comply will result in punishment or faction strikes. Quality roleplay and proper escalation are mandatory at all times.
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
    return;
  }

  // Normal rendering for all tabs including tier1
  if(false){
    // Removed Christmas Spin feature
    contentArea.innerHTML = `
      <div style="max-width:1100px; margin:0 auto; padding:24px;">
        <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin-bottom:20px; text-align:center;">
          <i class="fa-solid fa-gun"></i> Tier 1 Weaponry
        </h3>
        <div class="grid-wrap"><div class="grid" id="itemGrid" aria-live="polite"></div></div>
      </div>
    `;
    itemGrid = document.getElementById('itemGrid');
    itemGrid.innerHTML = '';
    if(nodes.length === 0){
      itemGrid.innerHTML = '<div style="grid-column:1/-1; color:var(--muted); padding:18px; text-align:center;">No items in this category.</div>';
      return;
    }
    nodes.forEach(it => itemGrid.appendChild(createCard(it)));
    return;
  }

  contentArea.innerHTML = `<div class="grid-wrap"><div class="grid" id="itemGrid" aria-live="polite"></div></div>`;
  itemGrid = document.getElementById('itemGrid');
  itemGrid.innerHTML = '';
  if(nodes.length === 0){
    itemGrid.innerHTML = '<div style="grid-column:1/-1; color:var(--muted); padding:18px; text-align:center;">No items in this category.</div>';
    return;
  }
  nodes.forEach(it => itemGrid.appendChild(createCard(it)));
}

/* open popup from card */
function openWeaponPopupFromCard(item){
  const name = item.name;
  const rarity = item.rarity || 'common';
  const isDrug = activeTab === 'drugs';
  const stats = isDrug ? DRUG_PRICES[name] : WEAPON_STATS[name] || {};
  openWeaponPopup(name, rarity, stats, item.img || FALLBACK, isDrug);
}

/* open popup generic */
function openWeaponPopup(name, rarity, stats, img, isDrug = false){
  weaponPopupName.textContent = name;
  weaponPopupRarity.textContent = (rarity||'common').toUpperCase();
  weaponPopupImage.src = img || FALLBACK;
  
  if(isDrug) {
    // Show price for drugs
    const statsGrid = document.querySelector('.weapon-stats-grid');
    statsGrid.innerHTML = `
      <div class="stat-card" style="grid-column: 1 / -1;">
        <div class="stat-title">Price</div>
        <div class="stat-value" style="color:var(--accent); font-size:28px;">${stats.price || '-'}</div>
      </div>
    `;
  } else {
    // Show weapon stats
    const statsGrid = document.querySelector('.weapon-stats-grid');
    statsGrid.innerHTML = `
      <div class="stat-card stat-card-1 stat-card-large">
        <div class="stat-title">Damage</div>
        <div class="stat-value">${stats.damage ?? '-'}</div>
      </div>
      <div class="stat-card stat-card-2 stat-card-large">
        <div class="stat-title">Fire Rate</div>
        <div class="stat-value">${stats.fire ? (stats.fire + ' RPM') : '-'}</div>
      </div>
      <div class="stat-card stat-card-3">
        <div class="stat-title">Ammo</div>
        <div class="stat-value">${stats.ammo ?? '-'}</div>
      </div>
      <div class="stat-card stat-card-4">
        <div class="stat-title">Magazine</div>
        <div class="stat-value">${(stats.magStd ? ('Reg: ' + stats.magStd) : '-') + (stats.magExt ? (' | Ext: ' + stats.magExt) : '')}</div>
      </div>
    `;
  }
  
  weaponPopup.classList.remove('hidden');
  weaponPopup.setAttribute('aria-hidden','false');
}
function closeWeaponPopup(){
  weaponPopup.classList.add('hidden');
  weaponPopup.setAttribute('aria-hidden','true');
}

/* fallback stats modal close */
closeStats.addEventListener('click', ()=> { statsModal.classList.remove('open'); statsModal.style.display = 'none'; });
statsModal.addEventListener('click', (e)=> { if(e.target === statsModal){ statsModal.classList.remove('open'); statsModal.style.display = 'none'; } });

/* topnav click handler with delegation */
document.querySelector('.topnav').addEventListener('click', (e) => {
  const cat = e.target.closest('.cat');
  if(!cat) return;
  document.querySelectorAll('.topnav .cat').forEach(x=> x.classList.remove('active'));
  cat.classList.add('active');
  activeTab = cat.dataset.tab;
  renderSubtabs(activeTab);
  renderGrid();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* subtabs event delegation */
subtabsEl.addEventListener('click', (e) => {
  const sub = e.target.closest('.sub');
  if(!sub) return;
  const active = subtabsEl.querySelector('.sub.active');
  if(active) active.classList.remove('active');
  sub.classList.add('active');
  activeSub = sub.dataset.sub;
  renderGrid();
});

/* filter with debounce */
filterSelect.addEventListener('change', debounce(() => renderGrid(), 100));

/* music toggle */
const musicIcon = musicToggle.querySelector('i');
function setMusicOn(on){
  localStorage.setItem('qc_music_on', on ? '1':'0');
  if(on){ 
    musicToggle.classList.add('on'); 
    musicLabel.textContent = 'Music: On'; 
    musicIcon.className='fa-solid fa-volume-high'; 
    bgm.play().catch(()=>{}); 
  } else { 
    musicToggle.classList.remove('on'); 
    musicLabel.textContent = 'Music: Off'; 
    musicIcon.className='fa-solid fa-volume-xmark'; 
    bgm.pause(); 
  }
}
musicToggle.addEventListener('click', ()=> {
  const current = localStorage.getItem('qc_music_on') === '1';
  setMusicOn(!current);
});
// Lazy audio init on first interaction
let audioInitialized = false;
function enableBGM(){ 
  function start(){ 
    if(!audioInitialized && bgm){ 
      bgm.play().catch(()=>{}); 
      audioInitialized = true;
    } 
    document.removeEventListener('click', start); 
    document.removeEventListener('touchstart', start); 
  } 
  document.addEventListener('click', start, { once: true, passive: true }); 
  document.addEventListener('touchstart', start, { once: true, passive: true }); 
}
enableBGM();
setTimeout(()=> { const mp = localStorage.getItem('qc_music_on'); setMusicOn(mp !== '0'); }, 100);

/* spinner modal logic: 1 second spin with easing */
function renderSpinStrip(targetItem = null){
  const pool = ITEMS[activeTab];
  if(!pool || pool.length === 0){ 
    spinStrip.innerHTML = '<div style="color:var(--muted)">No items in this category.</div>'; 
    return; 
  }
  const fragment = document.createDocumentFragment();
  const poolLen = pool.length;
  const tileStyle = 'min-width:140px;height:120px;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,rgba(0,0,0,.16),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.04);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;contain:layout style paint;';
  
  for(let i=0;i<15;i++){
    // Place target item at the end position where it will land after animation
    const it = (targetItem && i === 14) ? targetItem : pool[Math.floor(Math.random() * poolLen)];
    const tile = document.createElement('div');
    tile.className = 'spin-tile';
    tile.style.cssText = tileStyle;
    tile.innerHTML = `<div style="font-weight:900;color:var(--muted);margin-bottom:6px;">${it.name}</div><img src="${it.img}" style="max-width:100%;max-height:64px;object-fit:contain" loading="eager" onerror="this.src='${FALLBACK}'">`;
    fragment.appendChild(tile);
  }
  spinStrip.innerHTML = '';
  spinStrip.appendChild(fragment);
}

/* ---------- Christmas Spin Function ---------- */
// Christmas spin removed

function computeDelays(durationMs, steps){
  // produce delays (ms) per step using easing (i/n)^2 weights and normalize to duration
  const weights = [];
  let sum = 0;
  for(let i=1;i<=steps;i++){
    const w = Math.pow(i/steps, 2); // quadratic easing (accelerating weight -> decelerating delays)
    weights.push(w); sum += w;
  }
  return weights.map(w => (w / sum) * durationMs);
}

spinStartBtn.addEventListener('click', async ()=>{
  if(spinning) return;
  spinning = true;
  playSFX('spin');
  landedGunDisplay.style.display = 'none';
  
  // Determine drop count
  const itemCount = activeTab === 'tier1' ? 4 : activeTab === 'tier2' ? 6 : activeTab === 'tier1_5' ? 5 : 2;
  const pickedItems = [];
  const steps = 12;
  const duration = 700;
  const delays = computeDelays(duration, steps);
  
  // Spin for each item
  for(let spinIndex = 0; spinIndex < itemCount; spinIndex++) {
    landedGunDisplay.style.display = 'none';
    
    const item = pickWeightedItem(activeTab);
    pickedItems.push(item);
    
    renderSpinStrip(item);
    
    // Animate wheel - show the gun landing
    for (let i = 0; i < steps; i++){
      const first = spinStrip.firstElementChild;
      if(first) spinStrip.appendChild(first);
      await tick(delays[i]);
    }
    
    // Ensure the selected item is visible in the center
    await tick(100);
    
    // Show landed item
    landedGunImage.src = item.img || FALLBACK;
    landedGunName.textContent = item.name;
    landedGunRarity.textContent = (item.rarity || 'common').toUpperCase();
    landedGunRarity.style.color = getRarityColor(item.rarity);
    landedGunDisplay.style.display = 'block';
    
    await tick(spinIndex < itemCount - 1 ? 600 : 400);
  }
  
  // Add items to acquired AFTER all spins complete
  pickedItems.forEach(item => addAcquired(item));
  
  sendWebhook({ action:'spin', tier:activeTab, result:`${itemCount} items`, ts:new Date().toISOString() });
  playSFX('win');
  closeSpinModal();
  spinning = false;
  showVictoryFrame(pickedItems);
});

function getRarityColor(rarity) {
  const colors = {
    common: '#8b7355',
    uncommon: '#4caf50',
    rare: '#2196f3',
    epic: '#9c27b0',
    legendary: '#ff9800'
  };
  return colors[rarity] || colors.common;
}

function openSpinModal(){ spinModal.classList.add('open'); spinModal.style.display='flex'; renderSpinStrip(); }
function closeSpinModal(){ spinModal.classList.remove('open'); spinModal.style.display='none'; }
dropBtn.addEventListener('click', openSpinModal);
closeSpin.addEventListener('click', closeSpinModal);

/* Victory Frame Functions */
function showVictoryFrame(items) {
  const victoryFrame = document.getElementById('victoryFrame');
  const victoryItemsGrid = document.getElementById('victoryItemsGrid');
  const victoryCount = document.getElementById('victoryCount');
  const victoryHeaderText = document.getElementById('victoryHeaderText');
  
  // Update header
  victoryHeaderText.textContent = 'YOU GOT:';
  victoryCount.textContent = `${items.length} ITEM${items.length > 1 ? 'S' : ''}`;
  
  // Clear existing items
  victoryItemsGrid.innerHTML = '';
  
  // Use document fragment for better performance
  const fragment = document.createDocumentFragment();
  items.forEach((item, index) => {
    const itemEl = document.createElement('div');
    itemEl.className = 'victory-item';
    itemEl.innerHTML = `
      <div class="victory-image-container">
        <img src="${item.img || FALLBACK}" alt="${item.name}" loading="eager" onerror="this.src='${FALLBACK}'">
      </div>
      <div class="victory-item-name">${item.name}</div>
      <div class="victory-item-rarity ${item.rarity.toLowerCase()}">${item.rarity.toUpperCase()}</div>
    `;
    fragment.appendChild(itemEl);
  });
  victoryItemsGrid.appendChild(fragment);
  
  // Adjust grid columns based on item count
  if(items.length === 2) {
    victoryItemsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
  } else if(items.length === 4) {
    victoryItemsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
  } else if(items.length === 6) {
    victoryItemsGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
  }
  
  requestAnimationFrame(() => {
    victoryFrame.style.display = 'flex';
  });
  playSFX('win');
}

function closeVictoryFrame() {
  const victoryFrame = document.getElementById('victoryFrame');
  victoryFrame.style.display = 'none';
}

document.getElementById('victoryCollectBtn').addEventListener('click', closeVictoryFrame);
document.getElementById('victoryFrame').addEventListener('click', (e) => {
  if (e.target.id === 'victoryFrame') closeVictoryFrame();
});

/* weighting picker */
function pickRarity(weights){
  const entries = Object.entries(weights).filter(([k,v])=> Number(v) > 0);
  const total = entries.reduce((s,[_k,v])=> s + Number(v), 0);
  const r = Math.random() * total; let acc = 0;
  for(const [k,v] of entries){ acc += Number(v); if(r <= acc) return k; }
  return entries[entries.length-1][0];
}
function pickWeightedItem(tabKey){
  const w = getWeights();
  const weights = w[tabKey] || DEFAULT_WEIGHTS[tabKey] || DEFAULT_WEIGHTS.tier1;
  const rarity = pickRarity(weights);
  const pool = (ITEMS[tabKey]||[]).filter(i=> i.rarity === rarity);
  if(pool.length) return rand(pool);
  // If no items of that rarity exist in this tab, pick from any rarity in THIS tab only
  const tabItems = ITEMS[tabKey] || [];
  if(tabItems.length) return rand(tabItems);
  // Ultimate fallback: tier1 items
  return rand(ITEMS.tier1 || [{ name:'Fallback', rarity:'common', category:'Unknown', img:FALLBACK }]);
}

/* acquired */
function addAcquired(item){
  acquired.unshift(item);
  const card = document.createElement('div');
  card.className = 'drop-card';
  card.style.display='flex'; card.style.gap='10px'; card.style.alignItems='center'; card.style.padding='8px'; card.style.borderRadius='10px';
  card.style.border='1px solid rgba(255,255,255,.04)'; card.style.background='linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0))';
  card.innerHTML = `<img src="${item.img}" style="width:56px;height:56px;object-fit:contain;border-radius:8px;" onerror="this.src='${FALLBACK}'"><div><div style="font-weight:900">${item.name}</div><div style="color:var(--muted);font-size:12px">${(item.rarity||'common').toUpperCase()}</div></div>`;
  card.addEventListener('click', ()=> openWeaponPopupFromCard(item));
  acquiredGrid.prepend(card);
  while(acquiredGrid.children.length > 120) acquiredGrid.removeChild(acquiredGrid.lastChild);
}

/* SFX - Lazy init audio context on first interaction */
let audioCtx = null;
const initAudioCtx = () => {
  if(audioCtx) return audioCtx;
  audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;
  return audioCtx;
};
function playTone(freq,len=0.08,type='sine',gain=0.06){
  const ctx = initAudioCtx();
  if(!ctx) return;
  try{ const o = ctx.createOscillator(); const g = ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); const now = ctx.currentTime; g.gain.value=0; g.gain.linearRampToValueAtTime(gain, now+0.01); o.start(now); g.gain.exponentialRampToValueAtTime(0.0001, now+len); o.stop(now+len+0.02); }catch(e){}
}
function playSFX(name){
  const ctx = initAudioCtx();
  if(!ctx) return;
  if(ctx.state === 'suspended') ctx.resume().catch(()=>{});
  if(name === 'click') playTone(880,0.06,'square',0.05);
  if(name === 'spin') playTone(240,0.12,'sawtooth',0.12);
  if(name === 'win'){ playTone(880,0.08,'sine',0.12); setTimeout(()=>playTone(1320,0.12,'sine',0.11),120); setTimeout(()=>playTone(1760,0.16,'sine',0.09),260); }
}

/* webhooks */
function sendWebhook(payload){
  const cfg = loadCfg();
  const webhook = cfg.webhook || '';
  if(!webhook) return;
  fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: `Quaker | ${payload.action} → ${payload.result||''} (${payload.rarity||''}) — ${payload.ts||''}` }) })
    .catch(e=> console.warn('webhook fail', e));
}

/* User profile modal */
async function showUserProfileModal(user) {
  const threads = await getThreadsFromDB();
  const userThreads = threads.filter(t => t.author === user.username);
  const joinDate = new Date().toLocaleDateString(); // Could store actual join date in user object
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay open';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" style="max-width:600px; background:rgba(70,70,70,.95);">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:24px;">
        <div>
          <h3 style="color:var(--accent); font-weight:900; font-size:28px; margin:0 0 8px 0;">
            <i class="fa-solid fa-user-circle"></i> ${user.username}
          </h3>
          <div style="color:var(--muted); font-size:14px;">Member since ${joinDate}</div>
        </div>
        <button class="btn" id="closeProfileModal"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div style="background:linear-gradient(180deg,rgba(30,144,255,.1),rgba(13,17,23,.05)); border:2px solid var(--glass-border); border-radius:12px; padding:24px; margin-bottom:20px;">
        <h4 style="color:var(--accent); font-weight:800; font-size:18px; margin:0 0 16px 0;">
          <i class="fa-solid fa-chart-simple"></i> Statistics
        </h4>
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:16px;">
          <div style="background:rgba(0,0,0,.4); padding:16px; border-radius:8px; text-align:center;">
            <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Total Threads</div>
            <div style="color:var(--accent); font-size:28px; font-weight:900;">${userThreads.length}</div>
          </div>
          <div style="background:rgba(0,0,0,.4); padding:16px; border-radius:8px; text-align:center;">
            <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Username</div>
            <div style="color:var(--text); font-size:20px; font-weight:700;">${user.username}</div>
          </div>
        </div>
      </div>

      <div style="background:rgba(0,0,0,.3); border:1px solid var(--glass-border); border-radius:12px; padding:20px; margin-bottom:20px;">
        <h4 style="color:var(--accent); font-weight:800; font-size:18px; margin:0 0 12px 0;">
          <i class="fa-solid fa-list"></i> Recent Threads
        </h4>
        ${userThreads.length === 0 ? `
          <div style="color:var(--muted); text-align:center; padding:20px;">
            <i class="fa-solid fa-inbox" style="font-size:32px; display:block; margin-bottom:8px; opacity:0.5;"></i>
            No threads posted yet
          </div>
        ` : userThreads.slice(0, 5).map(thread => `
          <div style="padding:12px; background:rgba(255,255,255,.02); border-radius:8px; margin-bottom:8px; border-left:3px solid var(--accent);">
            <div style="font-weight:700; color:var(--text); margin-bottom:4px;">${thread.title}</div>
            <div style="font-size:12px; color:var(--muted);">
              <span style="background:rgba(30,144,255,.2); color:var(--accent); padding:2px 8px; border-radius:4px; margin-right:6px;">${thread.schemeType}</span>
              ${new Date(thread.date).toLocaleDateString()}
            </div>
          </div>
        `).join('')}
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn" id="profileLogout" style="background:rgba(30,144,255,.2); border-color:var(--accent);">
          <i class="fa-solid fa-right-from-bracket"></i>&nbsp;Logout
        </button>
        <button class="btn drop" id="closeProfileBtn">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  document.getElementById('closeProfileModal').addEventListener('click', () => modal.remove());
  document.getElementById('closeProfileBtn').addEventListener('click', () => modal.remove());
  document.getElementById('profileLogout').addEventListener('click', () => {
    localStorage.removeItem('forum_current_user');
    updateUserProfile();
    modal.remove();
    if(activeTab === 'forums') renderGrid();
  });
  modal.addEventListener('click', (e) => {
    if(e.target === modal) modal.remove();
  });
}

/* startup */
function init(){
  renderSubtabs(activeTab);
  renderGrid();
  updateUserProfile();
  const cfg = loadCfg();
  document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
  // music pref
  const mp = localStorage.getItem('qc_music_on');
  setTimeout(()=> setMusicOn(mp !== '0'), 60);
  // Allow audio context resume on first interaction
  document.addEventListener('click', ()=> { const ctx = initAudioCtx(); if(ctx && ctx.state === 'suspended') ctx.resume().catch(()=>{}); }, { passive: true });
  console.log('TFB Illegal Factions system ready');
}

/* Forum modal functions */
function showNewThreadModal(username) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay open';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" style="max-width:700px; background:rgba(70,70,70,.95);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:var(--accent); font-weight:900; font-size:24px; margin:0;">
          <i class="fa-solid fa-plus"></i> Create New Thread
        </h3>
        <button class="btn" id="closeThreadModal"><i class="fa-solid fa-xmark"></i></button>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Thread Title *</label>
        <input type="text" id="threadTitle" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(60,60,60,.6); color:var(--text); font-family:inherit;" placeholder="Be specific and creative">
      </div>

      <div style="margin-bottom:16px;">
        <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Scheme Type *</label>
        <select id="schemeType" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(60,60,60,.6); color:var(--text); font-family:inherit; font-weight:700;">
          <option value="">-- Select --</option>
          <option value="Scammer">Scammer</option>
          <option value="Racer">Racer</option>
          <option value="Drug Dealer">Drug Dealer</option>
        </select>
      </div>

      <div style="margin-bottom:16px;">
        <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Thread Type *</label>
        <select id="threadType" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(60,60,60,.6); color:var(--text); font-family:inherit; font-weight:700;">
          <option value="">-- Select --</option>
          <option value="Individual (I)">Individual (I)</option>
          <option value="Group (G)">Group (G)</option>
        </select>
      </div>

      <div style="margin-bottom:20px;">
        <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px;">Video (Optional)</label>
        <div style="background:rgba(80,80,80,.4); border:1px solid var(--glass-border); border-radius:8px; padding:12px; margin-bottom:8px;">
          <div style="color:var(--muted); font-size:13px; margin-bottom:8px; font-weight:600;">Option 1: Upload Video File</div>
          <input type="file" id="videoUpload" accept="video/*" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--glass-border); background:rgba(60,60,60,.5); color:var(--text); font-family:inherit;">
          <div style="color:var(--muted); font-size:11px; margin-top:4px;"><i class="fa-solid fa-info-circle"></i> Max 100MB (supports 1-minute videos)</div>
        </div>
        <div style="background:rgba(80,80,80,.4); border:1px solid var(--glass-border); border-radius:8px; padding:12px;">
          <div style="color:var(--muted); font-size:13px; margin-bottom:8px; font-weight:600;">Option 2: Video URL</div>
          <input type="text" id="videoUrl" placeholder="https://example.com/video.mp4 or YouTube/Streamable link" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--glass-border); background:rgba(60,60,60,.5); color:var(--text); font-family:inherit;">
          <div style="color:var(--muted); font-size:11px; margin-top:4px;"><i class="fa-solid fa-link"></i> Paste direct video link or embed URL</div>
        </div>
      </div>

      <div id="threadError" style="color:#ff4444; margin-bottom:12px; display:none; padding:12px; background:rgba(255,0,0,.1); border-radius:8px; border:1px solid #ff4444;"></div>

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn" id="cancelThread">Cancel</button>
        <button class="btn drop" id="submitThread"><i class="fa-solid fa-paper-plane"></i>&nbsp;Submit Thread</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  document.getElementById('closeThreadModal').addEventListener('click', () => modal.remove());
  document.getElementById('cancelThread').addEventListener('click', () => modal.remove());
  
  document.getElementById('submitThread').addEventListener('click', async () => {
    const title = document.getElementById('threadTitle').value.trim();
    const schemeType = document.getElementById('schemeType').value;
    const threadType = document.getElementById('threadType').value;
    const videoFile = document.getElementById('videoUpload').files[0];
    const errorDiv = document.getElementById('threadError');
    const submitBtn = document.getElementById('submitThread');

    if(!title || !schemeType || !threadType) {
      errorDiv.textContent = 'Please fill all required fields';
      errorDiv.style.display = 'block';
      return;
    }

    let videoUrl = null;
    let videoType = null;
    const videoUrlInput = document.getElementById('videoUrl').value.trim();
    
    // Check if URL is provided
    if(videoUrlInput && videoFile) {
      errorDiv.textContent = 'Please choose either file upload OR URL, not both';
      errorDiv.style.display = 'block';
      return;
    }
    
    if(videoUrlInput) {
      // Use provided URL
      videoUrl = videoUrlInput;
      videoType = 'url';
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Posting...';
    } else if(videoFile) {
      // Upload file
      if(videoFile.size > 100 * 1024 * 1024) {
        errorDiv.textContent = 'Video file too large (max 100MB for 1-minute videos)';
        errorDiv.style.display = 'block';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Uploading...';
      errorDiv.style.display = 'none';
      
      try {
        videoUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            if(e.target && e.target.result) {
              resolve(e.target.result);
            } else {
              reject(new Error('Failed to read file'));
            }
          };
          reader.onerror = () => reject(new Error('File read error'));
          reader.readAsDataURL(videoFile);
        });
        videoType = videoFile.type;
      } catch(e) {
        console.error('Video upload error:', e);
        errorDiv.textContent = 'Failed to upload video: ' + (e.message || 'Unknown error');
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>&nbsp;Submit Thread';
        return;
      }
    } else {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Posting...';
    }

    try {
      const threadId = 'thread_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      const thread = {
        id: threadId,
        title,
        schemeType,
        threadType,
        author: username,
        date: new Date().toISOString(),
        videoUrl,
        videoType,
        comments: []
      };

      await saveThreadToDB(thread);
      
      modal.remove();
      renderGrid(true);
    } catch(e) {
      console.error('Thread creation error:', e);
      errorDiv.textContent = 'Failed to create thread. Please try again.';
      errorDiv.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>&nbsp;Submit Thread';
    }
  });

  modal.addEventListener('click', (e) => {
    if(e.target === modal) modal.remove();
  });
}

async function showThreadModal(thread) {
  const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
  const comments = thread.comments || [];
  const videoTypeAttr = thread.videoType ? `type="${thread.videoType}"` : 'type="video/mp4"';
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay open';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" style="max-width:1000px; max-height:90vh; overflow-y:auto; background:rgba(70,70,70,.95);">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
        <div style="flex:1;">
          <h3 style="color:var(--accent); font-weight:900; font-size:28px; margin:0 0 12px 0;">${thread.title}</h3>
          <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
            <span style="background:rgba(30,144,255,.2); color:var(--accent); padding:6px 14px; border-radius:6px; font-size:13px; font-weight:700;">
              <i class="fa-solid fa-tag"></i> ${thread.schemeType}
            </span>
            <span style="background:rgba(13,17,23,.2); color:#4a9eff; padding:6px 14px; border-radius:6px; font-size:13px; font-weight:700;">
              <i class="fa-solid fa-users"></i> ${thread.threadType}
            </span>
          </div>
          <div style="color:var(--muted); font-size:14px;">
            Posted by <strong style="color:var(--accent);">${thread.author}</strong> on ${new Date(thread.date).toLocaleDateString()}
          </div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="closeViewThread"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>

      ${thread.videoUrl ? `
        <div style="background:rgba(80,80,80,.7); border:2px solid var(--accent); border-radius:12px; padding:16px; margin-bottom:20px;">
          <div style="color:var(--accent); font-weight:700; margin-bottom:12px; font-size:16px;">
            <i class="fa-solid fa-video"></i> Thread Video
          </div>
          ${thread.videoType === 'url' ? `
            <div style="background:rgba(70,70,70,.6); padding:12px; border-radius:8px; margin-bottom:8px;">
              <a href="${thread.videoUrl}" target="_blank" style="color:var(--accent); text-decoration:none; word-break:break-all;">
                <i class="fa-solid fa-external-link-alt"></i> ${thread.videoUrl}
              </a>
            </div>
            ${thread.videoUrl.includes('youtube.com') || thread.videoUrl.includes('youtu.be') ? `
              <iframe width="100%" height="400" src="${thread.videoUrl.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius:8px;"></iframe>
            ` : thread.videoUrl.includes('streamable.com') ? `
              <iframe src="${thread.videoUrl.replace('streamable.com/', 'streamable.com/e/')}" width="100%" height="400" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe>
            ` : `
              <video controls style="width:100%; max-height:500px; border-radius:8px; background:#000;">
                <source src="${thread.videoUrl}">
                Your browser does not support video playback.
              </video>
            `}
          ` : `
            <video controls style="width:100%; max-height:500px; border-radius:8px; background:#000;">
              <source src="${thread.videoUrl}" ${videoTypeAttr}>
              Your browser does not support video playback.
            </video>
          `}
        </div>
      ` : `
        <div style="background:rgba(80,80,80,.5); border:1px solid var(--glass-border); border-radius:12px; padding:24px; text-align:center; color:var(--muted); margin-bottom:20px;">
          <i class="fa-solid fa-video-slash" style="font-size:32px; margin-bottom:12px; display:block; opacity:0.5;"></i>
          <div>No video attached to this thread</div>
        </div>
      `}

      <!-- Comments Section -->
      <div style="background:rgba(90,90,90,.5); border:1px solid var(--glass-border); border-radius:12px; padding:20px; margin-bottom:20px;">
        <h4 style="color:var(--accent); font-weight:800; font-size:20px; margin:0 0 16px 0;">
          <i class="fa-solid fa-comments"></i> Discussion (${comments.length})
        </h4>

        ${currentUser ? `
          <div style="background:rgba(100,100,100,.3); border:1px solid var(--glass-border); border-radius:8px; padding:16px; margin-bottom:20px;">
            <textarea id="newComment" placeholder="Add your comment..." style="width:100%; min-height:80px; padding:12px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(60,60,60,.6); color:var(--text); font-family:inherit; resize:vertical; margin-bottom:12px;"></textarea>
            <div style="margin-bottom:12px;">
              <label style="color:var(--muted); font-weight:700; display:block; margin-bottom:8px; font-size:14px;">Attach Video (Optional)</label>
              <div style="background:rgba(80,80,80,.4); border:1px solid var(--glass-border); border-radius:6px; padding:10px; margin-bottom:6px;">
                <div style="color:var(--muted); font-size:12px; margin-bottom:6px; font-weight:600;">Upload File:</div>
                <input type="file" id="commentVideo" accept="video/*" style="width:100%; padding:6px; border-radius:4px; border:1px solid var(--glass-border); background:rgba(60,60,60,.5); color:var(--text); font-family:inherit; font-size:12px;">
                <div style="color:var(--muted); font-size:10px; margin-top:4px;"><i class="fa-solid fa-info-circle"></i> Max 50MB</div>
              </div>
              <div style="background:rgba(80,80,80,.4); border:1px solid var(--glass-border); border-radius:6px; padding:10px;">
                <div style="color:var(--muted); font-size:12px; margin-bottom:6px; font-weight:600;">Or paste URL:</div>
                <input type="text" id="commentVideoUrl" placeholder="https://..." style="width:100%; padding:6px; border-radius:4px; border:1px solid var(--glass-border); background:rgba(60,60,60,.5); color:var(--text); font-family:inherit; font-size:12px;">
              </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn" id="clearComment"><i class="fa-solid fa-eraser"></i>&nbsp;Clear</button>
              <button class="btn drop" id="postComment"><i class="fa-solid fa-paper-plane"></i>&nbsp;Post Comment</button>
            </div>
          </div>
        ` : `
          <div style="background:rgba(30,144,255,.1); border:1px solid var(--accent); border-radius:8px; padding:16px; text-align:center; color:var(--muted); margin-bottom:20px;">
            <i class="fa-solid fa-lock" style="margin-right:8px;"></i>
            Please login to join the discussion
          </div>
        `}

        <div id="commentsList">
          ${comments.length === 0 ? `
            <div style="text-align:center; padding:40px; color:var(--muted);">
              <i class="fa-solid fa-comment-slash" style="font-size:36px; display:block; margin-bottom:12px; opacity:0.5;"></i>
              <div>No comments yet. Be the first to comment!</div>
            </div>
          ` : comments.map((comment, idx) => {
            const commentVideoType = comment.videoType ? `type="${comment.videoType}"` : 'type="video/mp4"';
            return `
            <div class="comment-item" data-idx="${idx}" style="background:rgba(110,110,110,.5); border-left:3px solid var(--accent); border-radius:8px; padding:16px; margin-bottom:12px;">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                <div>
                  <strong style="color:var(--accent); font-size:15px;">${comment.author}</strong>
                  <span style="color:var(--muted); font-size:13px; margin-left:12px;">${new Date(comment.date).toLocaleString()}</span>
                  ${comment.edited ? '<span style="color:var(--muted); font-size:12px; margin-left:8px; font-style:italic;">(edited)</span>' : ''}
                </div>
                ${currentUser && currentUser.username === comment.author ? `
                  <div style="display:flex; gap:8px;">
                    <button class="btn" style="padding:6px 12px; font-size:12px;" onclick="editComment('${thread.id}', ${idx})"><i class="fa-solid fa-edit"></i> Edit</button>
                    <button class="btn" style="padding:6px 12px; font-size:12px; background:rgba(30,144,255,.2);" onclick="deleteComment('${thread.id}', ${idx})"><i class="fa-solid fa-trash"></i> Delete</button>
                  </div>
                ` : ''}
              </div>
              <div class="comment-text" style="color:var(--text); line-height:1.6; white-space:pre-wrap; margin-bottom:${comment.videoUrl ? '12px' : '0'};">${comment.text}</div>
              ${comment.videoUrl ? `
                <div style="background:rgba(90,90,90,.6); border:1px solid var(--glass-border); border-radius:8px; padding:12px; margin-top:12px;">
                  <div style="color:var(--muted); font-size:12px; margin-bottom:8px;"><i class="fa-solid fa-video"></i> Attached Video</div>
                  ${comment.videoType === 'url' ? `
                    <div style="background:rgba(80,80,80,.6); padding:8px; border-radius:6px; margin-bottom:8px;">
                      <a href="${comment.videoUrl}" target="_blank" style="color:var(--accent); text-decoration:none; word-break:break-all; font-size:12px;">
                        <i class="fa-solid fa-external-link-alt"></i> ${comment.videoUrl}
                      </a>
                    </div>
                    ${comment.videoUrl.includes('youtube.com') || comment.videoUrl.includes('youtu.be') ? `
                      <iframe width="100%" height="250" src="${comment.videoUrl.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius:6px;"></iframe>
                    ` : comment.videoUrl.includes('streamable.com') ? `
                      <iframe src="${comment.videoUrl.replace('streamable.com/', 'streamable.com/e/')}" width="100%" height="250" frameborder="0" allowfullscreen style="border-radius:6px;"></iframe>
                    ` : `
                      <video controls style="width:100%; max-height:300px; border-radius:6px; background:#000;">
                        <source src="${comment.videoUrl}">
                        Your browser does not support video playback.
                      </video>
                    `}
                  ` : `
                    <video controls style="width:100%; max-height:300px; border-radius:6px; background:#000;">
                      <source src="${comment.videoUrl}" ${commentVideoType}>
                      Your browser does not support video playback.
                    </video>
                  `}
                </div>
              ` : ''}
            </div>
          `;
          }).join('')}
        </div>
      </div>

      <div style="text-align:right;">
        <button class="btn" id="closeViewThreadBtn">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  document.getElementById('closeViewThread').addEventListener('click', () => modal.remove());
  document.getElementById('closeViewThreadBtn').addEventListener('click', () => modal.remove());
  
  // Delete thread button
  if(currentUser && currentUser.username === thread.author) {
    const deleteBtn = document.getElementById('deleteThread');
    if(deleteBtn) {
      deleteBtn.addEventListener('click', async () => {
        if(confirm('Are you sure you want to delete this entire thread? This cannot be undone.')) {
          try {
            await deleteThreadFromDB(thread.id);
            modal.remove();
            // Refresh the forums grid
            await renderGrid(true);
            alert('Thread deleted successfully');
          } catch(e) {
            console.error('Delete thread error:', e);
            alert('Failed to delete thread. Please try again.');
          }
        }
      });
    }
  }
  
  if(currentUser) {
    document.getElementById('clearComment').addEventListener('click', () => {
      document.getElementById('newComment').value = '';
      document.getElementById('commentVideo').value = '';
      document.getElementById('commentVideoUrl').value = '';
    });

    document.getElementById('postComment').addEventListener('click', async () => {
      const commentText = document.getElementById('newComment').value.trim();
      const videoFile = document.getElementById('commentVideo').files[0];
      const videoUrlInput = document.getElementById('commentVideoUrl').value.trim();
      const postBtn = document.getElementById('postComment');
      
      if(!commentText && !videoFile && !videoUrlInput) {
        alert('Please enter a comment or attach a video');
        return;
      }
      
      if(videoFile && videoUrlInput) {
        alert('Please choose either file upload OR URL, not both');
        return;
      }
      
      let videoUrl = null;
      let videoType = null;
      
      if(videoUrlInput) {
        videoUrl = videoUrlInput;
        videoType = 'url';
        postBtn.disabled = true;
        postBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Posting...';
      } else if(videoFile) {
        if(videoFile.size > 50 * 1024 * 1024) {
          alert('Video file too large (max 50MB for comments)');
          return;
        }
        
        postBtn.disabled = true;
        postBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Uploading...';
        
        try {
          videoUrl = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              if(e.target && e.target.result) {
                resolve(e.target.result);
              } else {
                reject(new Error('Failed to read file'));
              }
            };
            reader.onerror = () => reject(new Error('File read error'));
            reader.readAsDataURL(videoFile);
          });
          videoType = videoFile.type;
        } catch(e) {
          console.error('Video upload error:', e);
          alert('Failed to upload video: ' + (e.message || 'Unknown error'));
          postBtn.disabled = false;
          postBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>&nbsp;Post Comment';
          return;
        }
      } else {
        postBtn.disabled = true;
        postBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>&nbsp;Posting...';
      }
      
      try {
        const newComment = {
          author: currentUser.username,
          text: commentText || '(Video only)',
          date: new Date().toISOString(),
          edited: false,
          videoUrl,
          videoType
        };
        
        const threads = await getThreadsFromDB();
        const threadIndex = threads.findIndex(t => t.id === thread.id);
        if(threadIndex !== -1) {
          if(!threads[threadIndex].comments) threads[threadIndex].comments = [];
          threads[threadIndex].comments.push(newComment);
          await updateThreadInDB(thread.id, { comments: threads[threadIndex].comments });
          
          // Refresh thread data from database to ensure we have latest
          const updatedThreads = await getThreadsFromDB();
          const updatedThreadIndex = updatedThreads.findIndex(t => t.id === thread.id);
          
          modal.remove();
          if(updatedThreadIndex !== -1) {
            showThreadModal(updatedThreads[updatedThreadIndex]);
          }
        } else {
          alert('Thread not found. It may have been deleted.');
          postBtn.disabled = false;
          postBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>&nbsp;Post Comment';
        }
      } catch(e) {
        console.error('Comment posting error:', e);
        alert('Failed to post comment. Please try again.');
        postBtn.disabled = false;
        postBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>&nbsp;Post Comment';
      }
    });
  }
  
  modal.addEventListener('click', (e) => {
    if(e.target === modal) modal.remove();
  });
}

async function editComment(threadId, commentIdx) {
  try {
    const threads = await getThreadsFromDB();
    const threadIndex = threads.findIndex(t => t.id === threadId);
    if(threadIndex === -1 || !threads[threadIndex].comments || !threads[threadIndex].comments[commentIdx]) {
      alert('Comment not found');
      return;
    }
    
    const comment = threads[threadIndex].comments[commentIdx];
    const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
    
    if(!currentUser || currentUser.username !== comment.author) {
      alert('You can only edit your own comments');
      return;
    }
    
    const newText = prompt('Edit your comment:', comment.text === '(Video only)' ? '' : comment.text);
    
    if(newText !== null && newText.trim()) {
      comment.text = newText.trim();
      comment.edited = true;
      await updateThreadInDB(threadId, { comments: threads[threadIndex].comments });
      
      // Refresh modal
      document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
      showThreadModal(threads[threadIndex]);
    }
  } catch(e) {
    console.error('Edit comment error:', e);
    alert('Failed to edit comment');
  }
}

async function deleteComment(threadId, commentIdx) {
  if(!confirm('Are you sure you want to delete this comment?')) return;
  
  try {
    const threads = await getThreadsFromDB();
    const threadIndex = threads.findIndex(t => t.id === threadId);
    if(threadIndex === -1 || !threads[threadIndex].comments || !threads[threadIndex].comments[commentIdx]) {
      alert('Comment not found');
      return;
    }
    
    const comment = threads[threadIndex].comments[commentIdx];
    const currentUser = JSON.parse(localStorage.getItem('forum_current_user') || 'null');
    
    if(!currentUser || currentUser.username !== comment.author) {
      alert('You can only delete your own comments');
      return;
    }
    
    threads[threadIndex].comments.splice(commentIdx, 1);
    await updateThreadInDB(threadId, { comments: threads[threadIndex].comments });
    
    // Refresh modal
    document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
    showThreadModal(threads[threadIndex]);
  } catch(e) {
    console.error('Delete comment error:', e);
    alert('Failed to delete comment');
  }
}

// Start immediately
init();

/* ESC closes modals */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ document.querySelectorAll('.modal-overlay.open').forEach(m=>{ m.classList.remove('open'); m.style.display='none'; }); weaponPopup.classList.add('hidden'); } });
/* backdrop close */
document.querySelectorAll('.modal-overlay').forEach(m=> m.addEventListener('click', (e)=> { if(e.target === m){ m.classList.remove('open'); m.style.display='none'; } }));

</script>
</body>
</html>
